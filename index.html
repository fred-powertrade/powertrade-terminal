<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<base href="/terminal/"/>
<title>KAITO — Institutional Crypto Risk Terminal</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#04040a;--bg2:#080810;--surface:#0c0c17;--surface2:#111120;--surface3:#181828;--surface4:#202035;
  --border:#131325;--border2:#1e1e35;--border3:#282840;
  --t1:#eeeef7;--t2:#a0a0c0;--t3:#666680;--t4:#40405a;--t5:#28283a;
  --cyan:#00e5ff;--cyan2:rgba(0,229,255,0.08);--cyan3:rgba(0,229,255,0.03);
  --green:#00dc82;--green2:rgba(0,220,130,0.10);--green3:rgba(0,220,130,0.04);
  --red:#ff3860;--red2:rgba(255,56,96,0.10);--red3:rgba(255,56,96,0.04);
  --amber:#ffb700;--amber2:rgba(255,183,0,0.10);
  --violet:#a855f7;--violet2:rgba(168,85,247,0.10);
  --pink:#ec4899;--blue:#3b82f6;--blue2:rgba(59,130,246,0.10);
  --orange:#f97316;--teal:#14b8a6;--teal2:rgba(20,184,166,0.10);
  --btc:#f7931a;--eth:#627eea;--sol:#9945ff;
  --regime-expansion:#ff3860;--regime-compression:#3b82f6;--regime-squeeze:#ffb700;--regime-trending:#00dc82;
}
html{background:var(--bg);color:var(--t1);font-family:'DM Sans',system-ui,sans-serif;font-size:13px;scrollbar-width:thin;scrollbar-color:var(--surface3) var(--bg)}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}
body{min-height:100vh;overflow-x:hidden}
a{color:var(--cyan);text-decoration:none}
.container{max-width:1820px;margin:0 auto;padding:0 18px}
.mono{font-family:'Space Mono',monospace}
.num-mono{font-family:'Space Mono',monospace;font-variant-numeric:tabular-nums}
.up{color:var(--green)}.dn{color:var(--red)}
.badge{display:inline-flex;align-items:center;padding:2px 7px;font-size:9px;font-weight:700;border-radius:4px;border:1px solid;gap:3px;letter-spacing:.03em}
.b-green{background:var(--green2);color:var(--green);border-color:rgba(0,220,130,.2)}
.b-red{background:var(--red2);color:var(--red);border-color:rgba(255,56,96,.2)}
.b-amber{background:var(--amber2);color:var(--amber);border-color:rgba(255,183,0,.2)}
.b-cyan{background:var(--cyan2);color:var(--cyan);border-color:rgba(0,229,255,.2)}
.b-violet{background:var(--violet2);color:var(--violet);border-color:rgba(168,85,247,.2)}
.b-blue{background:var(--blue2);color:var(--blue);border-color:rgba(59,130,246,.2)}
.b-neutral{background:rgba(255,255,255,.03);color:var(--t3);border-color:var(--border2)}
.tag{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600;letter-spacing:.03em}
.tag-bull{background:var(--green2);color:var(--green)}.tag-bear{background:var(--red2);color:var(--red)}
.tag-vol{background:var(--violet2);color:var(--violet)}.tag-hot{background:var(--amber2);color:var(--amber)}
.tag-info{background:var(--blue2);color:var(--blue)}.tag-sym{background:rgba(255,255,255,.04);color:var(--t2)}
.tag-teal{background:var(--teal2);color:var(--teal)}

/* ═══ LOGIN SCREEN ═══ */
#login-screen{position:fixed;top:0;left:0;right:0;bottom:0;background:#0f172a;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s}
#login-screen.hidden{opacity:0;pointer-events:none}
.login-card{background:#1e293b;backdrop-filter:blur(10px);border:1px solid rgba(99,102,241,0.2);border-radius:16px;padding:48px 40px;width:380px;box-shadow:0 25px 60px rgba(0,0,0,.5)}
.login-brand{text-align:center;margin-bottom:36px}
.login-brand h1{font-size:36px;font-weight:900;color:#f59e0b;letter-spacing:2px;margin-bottom:4px}
.login-brand p{font-size:11px;color:rgba(255,255,255,.35);letter-spacing:.12em;text-transform:uppercase}
.login-field{margin-bottom:18px}
.login-field label{display:block;font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.login-field input{width:100%;background:rgba(15,23,42,.8);border:1px solid rgba(99,102,241,.2);border-radius:8px;padding:12px 14px;color:#fff;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s}
.login-field input:focus{border-color:rgba(245,158,11,.5);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
.login-btn{width:100%;padding:13px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:8px;color:#0f172a;font-size:13px;font-weight:800;letter-spacing:.04em;cursor:pointer;font-family:inherit;transition:transform .1s,box-shadow .2s;margin-top:8px}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(245,158,11,.3)}
.login-btn:active{transform:translateY(0)}
.login-error{color:#ff3860;font-size:11px;text-align:center;margin-top:12px;min-height:16px}
.login-tier-info{margin-top:24px;padding-top:20px;border-top:1px solid rgba(99,102,241,.1)}
.login-tier{display:flex;align-items:center;justify-content:space-between;padding:6px 0;font-size:10px;color:rgba(255,255,255,.35)}
.login-tier .tier-name{color:rgba(245,158,11,.7);font-weight:700}
.login-tier .tier-price{font-family:'Space Mono',monospace}

/* Card */
.card{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden}
.card-h{padding:11px 15px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-shrink:0}
.card-t{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);display:flex;align-items:center;gap:6px}
.card-t .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.card-b{padding:13px 15px}.card-bnp{padding:0}
.scroll-y{overflow-y:auto}.scroll-sm{overflow-y:auto;max-height:320px}.scroll-md{overflow-y:auto;max-height:420px}

/* HEADER */
header{background:rgba(4,4,10,0.97);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:9px 0;gap:12px}
.logo{display:flex;align-items:center;gap:9px;flex-shrink:0}
.logo-m{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:11px;color:#0f172a;box-shadow:0 0 16px rgba(245,158,11,0.15);letter-spacing:1px}
.logo h1{font-size:14px;font-weight:800;letter-spacing:-.02em}.logo h1 b{color:#f59e0b}
.logo p{font-size:8px;color:var(--t4);letter-spacing:.07em;text-transform:uppercase;margin-top:-1px}
.hdr-center{display:flex;align-items:center;gap:20px;font-size:10px;flex:1;justify-content:center}
.hdr-stat{display:flex;flex-direction:column;align-items:center;gap:1px}
.hdr-stat .l{font-size:8px;color:var(--t4);letter-spacing:.06em;text-transform:uppercase}
.hdr-stat .v{font-size:11px;font-weight:700;font-family:'Space Mono',monospace}
.hdr-div{width:1px;height:28px;background:var(--border2)}
.hdr-r{display:flex;align-items:center;gap:12px;flex-shrink:0}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 2s infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.regime-pill{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.04em;border:1px solid;transition:all .3s}

/* MODE TOGGLE */
.mode-toggle{display:flex;background:var(--surface);border:1px solid var(--border2);border-radius:8px;overflow:hidden;margin-left:12px}
.mode-btn{padding:6px 16px;font-size:10px;font-weight:700;letter-spacing:.04em;cursor:pointer;border:none;background:transparent;color:var(--t3);font-family:inherit;transition:all .15s}
.mode-btn.active{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a}
.mode-btn:hover:not(.active){color:var(--t1);background:rgba(255,255,255,.03)}

/* MAIN TABS */
.main-tabs{background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:49px;z-index:190}
.main-tabs-inner{display:flex;gap:0}
.mtab{padding:9px 18px;font-size:11px;font-weight:600;color:var(--t4);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;user-select:none;white-space:nowrap;letter-spacing:.01em}
.mtab:hover{color:var(--t2);background:rgba(255,255,255,.008)}
.mtab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:rgba(0,229,255,.02)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* Ticker */
.ticker{background:var(--bg);border-bottom:1px solid rgba(19,19,37,.6);overflow:hidden;height:26px;display:flex;align-items:center}
.ticker-t{display:flex;gap:24px;animation:tscroll 90s linear infinite;white-space:nowrap}
@keyframes tscroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.ti{font-size:9.5px;font-family:'Space Mono',monospace;color:var(--t3)}.ti .s{color:var(--t2);font-weight:700}

/* Pills */
.pills{display:flex;gap:2px}
.pill{padding:4px 10px;font-size:9.5px;font-weight:600;border-radius:5px;cursor:pointer;border:1px solid var(--border);color:var(--t3);background:transparent;font-family:inherit;transition:all .12s;letter-spacing:.02em}
.pill:hover{border-color:var(--t4)}.pill.act{background:var(--cyan2);border-color:rgba(0,229,255,.25);color:var(--cyan)}
.pill.act-v{background:var(--violet2);border-color:rgba(168,85,247,.25);color:var(--violet)}
.pill.act-g{background:var(--green2);border-color:rgba(0,220,130,.25);color:var(--green)}
.pill.act-r{background:var(--red2);border-color:rgba(255,56,96,.25);color:var(--red)}
.pill.act-a{background:var(--amber2);border-color:rgba(255,183,0,.25);color:var(--amber)}

/* AI Search */
.ai-search-wrap{position:relative;margin-bottom:14px}
.ai-search{width:100%;background:rgba(245,158,11,.025);border:1px solid rgba(245,158,11,.12);border-radius:10px;padding:11px 100px 11px 38px;color:var(--t1);font-family:'Space Mono',monospace;font-size:11px;outline:none;transition:all .2s}
.ai-search:focus{border-color:rgba(245,158,11,.5);background:rgba(245,158,11,.05);box-shadow:0 0 0 3px rgba(245,158,11,.05)}
.ai-search::placeholder{color:var(--t4)}
.ai-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
.ai-kbd{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:4px;align-items:center}
.ai-response{background:var(--surface);border:1px solid rgba(245,158,11,.15);border-radius:10px;padding:14px 16px;margin-bottom:14px;display:none;font-size:12px;color:var(--t2);line-height:1.7}
.ai-response.show{display:block}
.ai-response .thinking{color:var(--t4);font-size:10px;font-family:'Space Mono',monospace;margin-bottom:8px}
.ai-cursor{display:inline-block;width:2px;height:12px;background:var(--amber);animation:blink 1s infinite;vertical-align:text-bottom;margin-left:2px}

/* Market Strip */
.mkt-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:12px 0}
.mkt-c{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:11px;transition:border-color .15s}
.mkt-c:hover{border-color:var(--border2)}
.mkt-c .l{font-size:8px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.05em}
.mkt-c .v{font-size:16px;font-weight:800;font-family:'Space Mono',monospace;margin-top:1px}
.mkt-c .c{font-size:9.5px;font-weight:600;margin-top:1px}
.mkt-c .sub{font-size:8px;color:var(--t4);margin-top:2px}

/* Regime Panel */
.regime-panel{background:var(--surface);border-radius:11px;padding:16px 20px;margin-bottom:14px;border:1px solid;position:relative;overflow:hidden}
.regime-panel::before{content:'';position:absolute;top:0;right:0;width:300px;height:100%;background:linear-gradient(270deg,var(--regime-glow,rgba(0,229,255,.04)) 0%,transparent 100%);pointer-events:none}
.regime-name{font-size:18px;font-weight:800;letter-spacing:-.02em;margin-bottom:4px}
.regime-sub{font-size:11px;color:var(--t3);line-height:1.5;max-width:600px}
.regime-meta{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
.regime-m-item{display:flex;flex-direction:column;gap:2px}
.regime-m-item .l{font-size:8px;color:var(--t4);text-transform:uppercase;letter-spacing:.06em}
.regime-m-item .v{font-size:12px;font-weight:700;font-family:'Space Mono',monospace}
.regime-actions{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px;text-align:right}
.regime-action-tag{font-size:9px;font-weight:700;padding:4px 10px;border-radius:4px;border:1px solid}

/* Signal Cards */
.signal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.sig-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.sig-card:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:0 6px 24px rgba(0,0,0,.3)}
.sig-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px}
.sig-card.sig-buy::after{background:var(--green)}.sig-card.sig-sell::after{background:var(--red)}
.sig-card.sig-vol::after{background:var(--violet)}.sig-card.sig-neutral::after{background:var(--amber)}
.sig-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.sig-asset{font-size:15px;font-weight:800;letter-spacing:-.01em}
.sig-conv{font-size:10px;font-weight:700;font-family:'Space Mono',monospace}
.sig-title{font-size:11px;font-weight:700;color:var(--t1);margin-bottom:4px}
.sig-desc{font-size:10.5px;color:var(--t3);line-height:1.55;margin-bottom:10px}
.sig-metrics{display:flex;gap:8px;flex-wrap:wrap}
.sig-m{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:4px 7px;text-align:center}
.sig-m .l{font-size:7.5px;color:var(--t4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:1px}
.sig-m .v{font-size:10px;font-weight:700;font-family:'Space Mono',monospace}
.sig-strategy{font-size:9.5px;font-weight:600;padding:6px 10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.1);border-radius:6px;color:var(--amber);margin-top:8px;display:flex;align-items:center;gap:5px}

/* Flow Feed */
.flow-item{padding:10px 14px;border-bottom:1px solid rgba(19,19,37,.5);display:flex;align-items:center;gap:10px;cursor:pointer;transition:background .1s}
.flow-item:hover{background:rgba(255,255,255,.015)}
.flow-item:last-child{border-bottom:none}
.flow-type{width:54px;font-size:8px;font-weight:700;text-align:center;padding:3px 0;border-radius:3px;flex-shrink:0;letter-spacing:.04em}
.flow-main{flex:1;min-width:0}
.flow-trade{font-size:11px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.flow-detail{font-size:9.5px;color:var(--t3);margin-top:1px;font-family:'Space Mono',monospace}
.flow-right{text-align:right;flex-shrink:0}
.flow-premium{font-size:11px;font-weight:700;font-family:'Space Mono',monospace}
.flow-time{font-size:8.5px;color:var(--t4);margin-top:1px;font-family:'Space Mono',monospace}
.flow-sweep{display:inline-block;font-size:7.5px;font-weight:700;padding:1px 4px;border-radius:2px;background:var(--amber2);color:var(--amber);border:1px solid rgba(255,183,0,.2);margin-left:4px}

/* IV + Skew + GEX common */
.iv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(68px,1fr));gap:2px}
.iv-cell{padding:7px 4px;border-radius:5px;text-align:center;cursor:pointer;transition:all .12s;border:1px solid transparent}
.iv-cell:hover{transform:scale(1.05);z-index:2;position:relative}
.iv-cell .sym{font-weight:800;font-size:10px;color:var(--t1)}
.iv-cell .ivr{font-size:10px;font-weight:700;font-family:'Space Mono',monospace;margin-top:1px}
.iv-cell .ivv{font-size:8px;color:var(--t4);margin-top:0}
.skew-row{display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid rgba(19,19,37,.4)}
.skew-row:last-child{border-bottom:none}
.skew-sym{font-weight:700;font-size:11px;width:45px;flex-shrink:0}
.skew-bar-wrap{flex:1;position:relative;height:8px;background:var(--surface3);border-radius:4px;overflow:visible}
.skew-bar-center{position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border2)}
.skew-bar-fill{position:absolute;top:0;height:100%;border-radius:4px}
.skew-val{font-size:10px;font-weight:700;font-family:'Space Mono',monospace;width:45px;text-align:right;flex-shrink:0}
.skew-label{font-size:8px;color:var(--t4);width:65px;text-align:right;flex-shrink:0}
.ivrvrow{display:flex;align-items:center;gap:8px;padding:7px 14px;border-bottom:1px solid rgba(19,19,37,.4)}
.ivrvrow:last-child{border-bottom:none}
.ivrv-sym{font-weight:700;font-size:11px;width:50px}
.ivrv-vals{display:flex;gap:12px;flex:1}
.ivrv-val{display:flex;flex-direction:column;gap:1px}
.ivrv-val .l{font-size:7.5px;color:var(--t4);text-transform:uppercase;letter-spacing:.04em}
.ivrv-val .v{font-size:11px;font-weight:700;font-family:'Space Mono',monospace}
.ivrv-spread{font-size:11px;font-weight:700;font-family:'Space Mono',monospace;width:55px;text-align:right}
.ivrv-signal{width:80px;text-align:right}
.gex-row{display:flex;align-items:center;gap:8px;padding:7px 13px;border-bottom:1px solid rgba(19,19,37,.35)}
.gex-row:last-child{border-bottom:none}
.gex-sym{font-weight:700;font-size:11px;width:50px}
.gex-bar-wrap{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative}
.gex-bar{height:100%;border-radius:3px}
.gex-val{font-size:9.5px;font-weight:700;font-family:'Space Mono',monospace;width:60px;text-align:right}
.gex-type{font-size:8px;width:70px;text-align:right;font-weight:600}

/* Funding bars */
.fb{display:flex;align-items:center;justify-content:space-between;padding:5px 12px;border-bottom:1px solid rgba(19,19,37,.3)}
.fb:last-child{border-bottom:none}
.fb-s{font-weight:700;font-size:10.5px;width:46px}
.fb-bar{flex:1;height:4px;background:var(--surface3);border-radius:2px;margin:0 8px;position:relative;overflow:hidden}
.fb-fill{height:100%;border-radius:2px;position:absolute}
.fb-v{font-family:'Space Mono',monospace;font-size:9.5px;width:60px;text-align:right}

/* Table */
.ftable{width:100%;border-collapse:collapse}
.ftable th{padding:6px 9px;font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--t4);text-align:left;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;cursor:pointer;user-select:none;z-index:5}
.ftable th:hover{color:var(--t2)}.ftable td{padding:5px 9px;font-size:10.5px;border-bottom:1px solid rgba(19,19,37,.35)}
.ftable tr:hover td{background:rgba(255,255,255,.012)}

/* Misc layout */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.g23{display:grid;grid-template-columns:2fr 1fr;gap:12px}
.g32{display:grid;grid-template-columns:3fr 2fr;gap:12px}
.mb{margin-bottom:12px}
.section-title{font-size:11px;font-weight:800;color:var(--t2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.divider{height:1px;background:var(--border);margin:14px 0}

/* Expected Move */
.em-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.em-card{background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:14px;text-align:center;position:relative;overflow:hidden}
.em-card::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:60%;height:2px;border-radius:0 0 2px 2px}
.em-card.em-7d::before{background:var(--cyan)}.em-card.em-14d::before{background:var(--blue)}
.em-card.em-30d::before{background:var(--violet)}.em-card.em-90d::before{background:var(--pink)}
.em-tenor{font-size:9px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.em-range{font-size:14px;font-weight:800;font-family:'Space Mono',monospace;margin-bottom:2px}
.em-pct{font-size:10px;color:var(--t3);font-family:'Space Mono',monospace;margin-bottom:6px}
.em-bar{height:6px;background:var(--surface3);border-radius:3px;position:relative;overflow:hidden;margin-bottom:4px}
.em-bar-fill{height:100%;border-radius:3px;position:absolute}
.em-1s{background:linear-gradient(90deg,rgba(0,229,255,.15),rgba(0,229,255,.4),rgba(0,229,255,.15))}
.em-2s{background:linear-gradient(90deg,rgba(168,85,247,.08),rgba(168,85,247,.2),rgba(168,85,247,.08))}
.em-labels{display:flex;justify-content:space-between;font-size:8px;color:var(--t4);font-family:'Space Mono',monospace}

/* Treemap */
.treemap{display:flex;flex-wrap:wrap;gap:2px;min-height:300px}
.tm{border-radius:6px;padding:7px;position:relative;overflow:hidden;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;justify-content:space-between}
.tm:hover{transform:scale(1.015);z-index:3;box-shadow:0 0 20px rgba(0,0,0,.5)}
.tm .s{font-weight:800;text-shadow:0 1px 2px rgba(0,0,0,.5)}.tm .p{font-family:'Space Mono',monospace;font-size:10px;opacity:.8;margin-top:1px}

/* Bubble */
.bubble-wrap{position:relative;height:360px;overflow:hidden}
.bubble-wrap canvas{width:100%;height:100%}

/* Gainers */
.gl-row{display:flex;align-items:center;justify-content:space-between;padding:7px 13px;border-bottom:1px solid rgba(19,19,37,.3);cursor:pointer;transition:background .1s}
.gl-row:hover{background:rgba(255,255,255,.018)}
.gl-row:last-child{border-bottom:none}
.gl-left{display:flex;align-items:center;gap:7px}
.gl-rank{width:16px;font-size:9px;color:var(--t4);font-weight:700;text-align:center}
.gl-sym{font-weight:700;font-size:11px}.gl-name{font-size:9px;color:var(--t4)}
.gl-right{text-align:right}.gl-chg{font-family:'Space Mono',monospace;font-size:11px;font-weight:700}
.gl-price{font-size:9px;color:var(--t3);font-family:'Space Mono',monospace}

/* Detail Panel */
.detail-panel{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;display:none;margin-bottom:14px}
.detail-panel.open{display:block}
.dp-header{display:flex;align-items:center;gap:14px;padding:16px;border-bottom:1px solid var(--border);background:var(--bg2)}
.dp-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;flex-shrink:0}
.dp-close{background:none;border:none;color:var(--t3);font-size:16px;cursor:pointer;padding:4px 8px;border-radius:6px;font-family:inherit}
.dp-close:hover{background:var(--surface3);color:var(--t1)}
.dp-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--border)}
.dp-stat{background:var(--surface);padding:12px;text-align:center}
.dp-stat .l{font-size:8px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
.dp-stat .v{font-size:14px;font-weight:700;font-family:'Space Mono',monospace}
.dp-section{padding:14px 16px;border-bottom:1px solid var(--border)}
.dp-section h4{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--t3);margin-bottom:8px}
.dp-tldr{font-size:11.5px;color:var(--t2);line-height:1.75;background:rgba(245,158,11,.025);border:1px solid rgba(245,158,11,.08);border-radius:8px;padding:12px 14px}
.dp-targets{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border)}
.dp-target{background:var(--surface);padding:10px;text-align:center}
.dp-target .l{font-size:7.5px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
.dp-target .v{font-size:13px;font-weight:700;font-family:'Space Mono',monospace}
.dp-target .sub{font-size:8px;color:var(--t4);margin-top:2px}

/* News */
.news-item{padding:11px 15px;border-bottom:1px solid rgba(19,19,37,.4);cursor:pointer;transition:background .1s}
.news-item:hover{background:rgba(255,255,255,.012)}
.news-item:last-child{border-bottom:none}
.news-time{font-size:8.5px;color:var(--t4);font-family:'Space Mono',monospace;margin-bottom:2px}
.news-title{font-size:11.5px;font-weight:600;color:var(--t1);line-height:1.45;margin-bottom:4px}
.news-tags{display:flex;gap:3px;flex-wrap:wrap}

/* Put/Call */
.pcr-row{display:flex;align-items:center;gap:8px;padding:7px 13px;border-bottom:1px solid rgba(19,19,37,.35)}
.pcr-row:last-child{border-bottom:none}
.pcr-sym{font-weight:700;font-size:11px;width:50px}
.pcr-bar{flex:1;height:8px;background:var(--surface3);border-radius:4px;position:relative;overflow:hidden;display:flex}
.pcr-calls{background:var(--green);height:100%;border-radius:4px 0 0 4px;opacity:.7}
.pcr-puts{background:var(--red);height:100%;border-radius:0 4px 4px 0;opacity:.7}
.pcr-val{font-size:10px;font-weight:700;font-family:'Space Mono',monospace;width:40px;text-align:right}
.pcr-signal{width:70px;text-align:right}

/* Max Pain (de-emphasized) */
.mp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mp-card{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:10px;text-align:center;opacity:.65}
.mp-sym{font-size:11px;font-weight:700;margin-bottom:2px;color:var(--t3)}
.mp-price{font-size:14px;font-weight:700;font-family:'Space Mono',monospace;color:var(--t3)}
.mp-delta{font-size:9px;color:var(--t4);margin-top:1px}

/* Strat card */
.strat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px}
.strat-h{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.strat-b{padding:14px}
.strat-pair{font-size:13px;font-weight:800;margin-bottom:3px}
.strat-desc{font-size:11px;color:var(--t2);line-height:1.6;margin:8px 0}
.strat-levels{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.strat-lv{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:8px;text-align:center}
.strat-lv .l{font-size:8px;color:var(--t4);text-transform:uppercase;letter-spacing:.04em;margin-bottom:2px}
.strat-lv .v{font-size:13px;font-weight:700;font-family:'Space Mono',monospace}
.strat-greeks{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:10px}
.strat-gk{text-align:center;padding:7px;background:var(--bg2);border-radius:5px}
.strat-gk .l{font-size:8px;color:var(--t4);margin-bottom:2px}
.strat-gk .v{font-size:10px;font-weight:600;font-family:'Space Mono',monospace}

/* Gamma Flip */
.gflip-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.gflip-col{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden}
.gflip-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border)}
.gflip-stat{background:var(--surface);padding:9px 10px;text-align:center}
.gflip-stat .l{font-size:7.5px;color:var(--t4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px}
.gflip-stat .v{font-size:11px;font-weight:700;font-family:'Space Mono',monospace}
.gflip-zone{margin:0 14px 10px;padding:9px 12px;background:rgba(255,183,0,.04);border:1px solid rgba(255,183,0,.12);border-radius:7px;font-size:10px;color:var(--t2);line-height:1.55}

/* RV Arb */
.rvarb-panel{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;margin-bottom:14px}
.rvarb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border)}
.rvarb-cell{background:var(--surface);padding:10px;text-align:center}
.rvarb-cell .l{font-size:7.5px;color:var(--t4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
.rvarb-cell .v{font-size:13px;font-weight:700;font-family:'Space Mono',monospace}
.rvarb-signal{padding:10px 15px;display:flex;align-items:center;gap:10px}
.rvarb-signal.arb-long{background:rgba(0,220,130,.04);border-top:1px solid rgba(0,220,130,.15)}
.rvarb-signal.arb-short{background:rgba(255,56,96,.04);border-top:1px solid rgba(255,56,96,.15)}
.rvarb-signal.arb-neutral{background:rgba(0,229,255,.02);border-top:1px solid rgba(0,229,255,.08)}
.rvarb-canvas-wrap{padding:10px 14px;border-top:1px solid var(--border)}
.rvarb-history{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 14px;border-top:1px solid var(--border)}
.rvarb-bar{text-align:center;padding:6px;background:var(--bg2);border-radius:6px}
.rvarb-bar .l{font-size:8px;color:var(--t4);margin-bottom:2px}
.rvarb-bar .v{font-size:10px;font-weight:700;font-family:'Space Mono',monospace}

/* TVE */
.tve-panel{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;margin-bottom:14px}
.tve-cols{display:grid;grid-template-columns:36px 50px 62px 1fr 56px 46px 42px 46px 50px;gap:0;padding:0 14px;font-size:8px;color:var(--t4);font-weight:700;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--border);align-items:center;height:28px}
.tve-body{max-height:340px;overflow-y:auto}
.tve-row{display:grid;grid-template-columns:36px 50px 62px 1fr 56px 46px 42px 46px 50px;gap:0;padding:5px 14px;border-bottom:1px solid rgba(19,19,37,.3);align-items:center;font-size:10px;transition:background .1s}
.tve-row:hover{background:rgba(255,255,255,.015)}

/* FG Widget */
.fg-arc-wrap{display:flex;flex-direction:column;align-items:center;gap:4px}
.fg-num{font-size:28px;font-weight:900;font-family:'Space Mono',monospace}
.fg-label{font-size:10px;font-weight:700;letter-spacing:.04em}

/* Blog */
.blog-link{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid rgba(19,19,37,.3);cursor:pointer}
.blog-link:last-child{border-bottom:none}
.blog-num{font-size:10px;color:var(--t5);font-weight:700;width:16px;flex-shrink:0;margin-top:1px}
.blog-text{font-size:11px;font-weight:600;color:var(--t2);line-height:1.4}
.blog-meta{font-size:9px;color:var(--t4);margin-top:2px}

/* Cats */
.cats{display:flex;flex-wrap:wrap;gap:3px}
.cat-b{padding:3px 9px;font-size:9.5px;font-weight:600;border-radius:14px;border:1px solid var(--border);color:var(--t3);background:transparent;cursor:pointer;font-family:inherit;transition:all .12s}
.cat-b:hover{border-color:var(--t4)}.cat-b.act{background:var(--cyan2);border-color:rgba(0,229,255,.25);color:var(--cyan)}

/* Scanner */
.scan-header{display:flex;align-items:center;gap:8px;padding:7px 13px;border-bottom:1px solid var(--border);background:var(--bg)}
.scan-row{display:flex;align-items:center;gap:8px;padding:7px 13px;border-bottom:1px solid rgba(19,19,37,.35);cursor:pointer;transition:background .1s}
.scan-row:hover{background:rgba(255,255,255,.015)}
.scan-row:last-child{border-bottom:none}
.scan-rank{width:22px;font-size:9px;color:var(--t4);font-weight:700;font-family:'Space Mono',monospace;text-align:right}
.scan-sym{font-weight:800;font-size:12px;width:52px;flex-shrink:0}
.scan-bar{flex:1;height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;position:relative;min-width:60px}
.scan-bar-fill{height:100%;border-radius:2px;position:absolute}
.scan-meta{display:flex;gap:10px;font-size:9.5px;font-family:'Space Mono',monospace;color:var(--t3);flex-shrink:0}
.scan-score{font-size:12px;font-weight:800;font-family:'Space Mono',monospace;width:36px;text-align:right}

/* Fair Value */
.fv-panel{background:linear-gradient(135deg,rgba(245,158,11,.03),rgba(168,85,247,.03));border:1px solid var(--border2);border-radius:11px;padding:16px;margin-bottom:14px;position:relative}
.fv-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.fv-models{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.fv-model{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px;text-align:center}
.fv-model .label{font-size:8px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px}
.fv-model .price{font-size:16px;font-weight:800;font-family:'Space Mono',monospace}
.fv-model .delta{font-size:10px;font-weight:600;margin-top:2px}
.fv-model .method{font-size:8px;color:var(--t4);margin-top:4px;line-height:1.3}
.fv-consensus{background:var(--bg2);border:1px solid var(--border2);border-radius:9px;padding:14px;text-align:center}
.fv-consensus .big-price{font-size:22px;font-weight:900;font-family:'Space Mono',monospace}
.fv-range-bar{height:10px;background:var(--surface3);border-radius:5px;position:relative;margin:10px 0 6px;overflow:visible}
.fv-range-fill{height:100%;border-radius:5px;position:absolute}
.fv-marker{position:absolute;top:-4px;width:2px;height:18px;border-radius:1px;z-index:3}
.fv-marker-label{position:absolute;top:-18px;font-size:7.5px;font-weight:700;white-space:nowrap;transform:translateX(-50%);left:50%}
.prob-cone-wrap{position:relative;background:var(--bg2);border-radius:8px;overflow:hidden}
.risk-meter{display:flex;gap:1px;margin-top:4px}
.risk-seg{height:4px;flex:1;border-radius:2px;background:var(--surface3)}

/* Spreads */
.flow-spread-tag{display:inline-flex;align-items:center;gap:3px;font-size:7.5px;font-weight:700;padding:1px 5px;border-radius:3px;margin-left:4px;letter-spacing:.02em}
.flow-spread-vert{background:rgba(168,85,247,.15);color:var(--violet);border:1px solid rgba(168,85,247,.25)}
.flow-spread-strad{background:rgba(0,229,255,.12);color:var(--cyan);border:1px solid rgba(0,229,255,.2)}
.flow-spread-strang{background:rgba(20,184,166,.12);color:var(--teal);border:1px solid rgba(20,184,166,.2)}
.flow-spread-cal{background:rgba(255,183,0,.12);color:var(--amber);border:1px solid rgba(255,183,0,.2)}
.flow-spread-reversal{background:rgba(236,72,153,.12);color:var(--pink);border:1px solid rgba(236,72,153,.2)}
.flow-intent{font-size:9px;color:var(--t3);margin-top:2px;padding-left:2px;font-style:italic}
.flow-leg-connector{font-size:8px;color:var(--t4);margin-top:1px;padding-left:2px;font-family:'Space Mono',monospace}
.flow-item.spread-leg{border-left:2px solid var(--violet);background:rgba(168,85,247,.02)}

/* ═══ DEALER HEDGING SIMULATOR ═══ */
.sim-panel{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;margin-bottom:14px}
.sim-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px}
.sim-control{display:flex;flex-direction:column;gap:6px}
.sim-control label{font-size:9px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.sim-control input[type=range]{width:100%;accent-color:#f59e0b;cursor:pointer}
.sim-control .sim-val{font-size:14px;font-weight:800;font-family:'Space Mono',monospace;color:var(--amber)}
.sim-output{padding:20px;background:linear-gradient(135deg,rgba(245,158,11,.04),rgba(255,56,96,.04));border-top:1px solid var(--border);text-align:center}
.sim-result{font-size:20px;font-weight:900;font-family:'Space Mono',monospace;margin-bottom:6px}
.sim-explain{font-size:11px;color:var(--t2);line-height:1.6}

/* ═══ VANNA/CHARM PANELS ═══ */
.greek-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
.greek-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden}
.greek-value{font-size:24px;font-weight:900;font-family:'Space Mono',monospace;text-align:center;padding:16px}
.greek-row{display:flex;align-items:center;gap:8px;padding:7px 13px;border-bottom:1px solid rgba(19,19,37,.35)}
.greek-row:last-child{border-bottom:none}
.greek-sym{font-weight:700;font-size:11px;width:50px}
.greek-bar-wrap{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative}
.greek-bar{height:100%;border-radius:3px}
.greek-val{font-size:9.5px;font-weight:700;font-family:'Space Mono',monospace;width:80px;text-align:right}
.greek-signal{width:80px;text-align:right}

/* Pricing tiers */
.tier-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:14px 0}
.tier-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:20px;position:relative;overflow:hidden;transition:border-color .2s}
.tier-card:hover{border-color:var(--border3)}
.tier-card.tier-highlight{border-color:rgba(245,158,11,.3)}
.tier-card.tier-highlight::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#f59e0b,#d97706)}
.tier-name{font-size:13px;font-weight:800;margin-bottom:2px}
.tier-target{font-size:9px;color:var(--t4);margin-bottom:10px}
.tier-price-tag{font-size:24px;font-weight:900;font-family:'Space Mono',monospace;color:var(--amber);margin-bottom:4px}
.tier-per{font-size:9px;color:var(--t4)}
.tier-features{margin-top:12px;list-style:none;padding:0}
.tier-features li{font-size:10px;color:var(--t2);padding:4px 0;border-bottom:1px solid rgba(19,19,37,.3);display:flex;align-items:center;gap:6px}
.tier-features li::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--green);flex-shrink:0}
</style>
</head>
<body>

<!-- ═══ LOGIN SCREEN (KAITO) ═══ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-brand">
      <h1>KAITO</h1>
      <p>Institutional Crypto Risk Terminal</p>
    </div>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="login-user" placeholder="Enter username" autocomplete="off"/>
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="Enter password" autocomplete="off"/>
    </div>
    <button class="login-btn" onclick="doLogin()">ACCESS TERMINAL</button>
    <div class="login-error" id="login-error"></div>
    <div class="login-tier-info">
      <div class="login-tier"><span class="tier-name">Pro Trader</span><span class="tier-price">$199/mo</span></div>
      <div class="login-tier"><span class="tier-name">Institutional Desk</span><span class="tier-price">$2,500/mo</span></div>
      <div class="login-tier"><span class="tier-name">Enterprise API</span><span class="tier-price">$10k+/mo</span></div>
    </div>
  </div>
</div>

<!-- ═══ MAIN APP (hidden until login) ═══ -->
<div id="app" style="display:none">

<!-- ═══ HEADER ═══ -->
<header><div class="container"><div class="hdr">
  <div class="logo">
    <div class="logo-m">K</div>
    <div><h1><b>KAITO</b></h1><p>Risk Intelligence Terminal</p></div>
  </div>

  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button class="mode-btn active" id="mode-spot" onclick="setMode('spot')">SPOT</button>
    <button class="mode-btn" id="mode-options" onclick="setMode('options')">OPTIONS</button>
  </div>

  <div class="hdr-center">
    <div class="hdr-stat">
      <span class="l">BTC</span>
      <span class="v num-mono" id="h-btcprice" style="color:var(--btc)">—</span>
    </div>
    <div class="hdr-div"></div>
    <div class="hdr-stat">
      <span class="l">ETH</span>
      <span class="v num-mono" id="h-ethprice" style="color:var(--eth)">—</span>
    </div>
    <div class="hdr-div"></div>
    <div class="hdr-stat" id="hdr-iv-stat">
      <span class="l">BTC IV</span>
      <span class="v num-mono" id="h-btciv" style="color:var(--amber)">—</span>
    </div>
    <div class="hdr-div" id="hdr-div-skew"></div>
    <div class="hdr-stat" id="hdr-skew-stat">
      <span class="l">BTC Skew</span>
      <span class="v num-mono" id="h-skew">—</span>
    </div>
    <div class="hdr-div"></div>
    <div class="hdr-stat">
      <span class="l">Total MCap</span>
      <span class="v num-mono" id="h-mc">—</span>
    </div>
    <div class="hdr-div"></div>
    <div class="hdr-stat">
      <span class="l">24H Vol</span>
      <span class="v num-mono" id="h-vol">—</span>
    </div>
  </div>

  <div class="hdr-r">
    <div id="regime-pill" class="regime-pill">
      <div class="live-dot"></div>
      <span id="regime-pill-text">DETECTING…</span>
    </div>
    <span class="mono" style="color:var(--t4);font-size:9px" id="clock"></span>
    <div id="live-status" style="display:flex;flex-direction:column;align-items:flex-end;gap:1px;min-width:70px">
      <div style="display:flex;align-items:center;gap:4px;font-size:8px;font-weight:700;letter-spacing:.04em;color:var(--t4)">
        <div style="width:5px;height:5px;border-radius:50%;background:var(--t4)"></div>
        CONNECTING…
      </div>
    </div>
  </div>
</div></div></header>

<!-- ═══ MAIN TABS — Mode-dependent ═══ -->
<div class="main-tabs"><div class="container"><div class="main-tabs-inner" id="main-tabs-inner">
  <!-- Populated by setMode() -->
</div></div></div>

<!-- TICKER -->
<div class="ticker"><div class="ticker-t" id="ticker"></div></div>

<div class="container" style="padding-top:12px;padding-bottom:40px">

<!-- All tab panels rendered here -->
<div id="tab-panels">
<!-- Panels injected by JavaScript based on mode -->
</div>

</div>

<!-- Footer -->
<div style="text-align:center;padding:20px;font-size:8.5px;color:var(--t5);border-top:1px solid var(--border);margin-top:20px">
  KAITO Risk Intelligence Terminal v6.0 · Institutional Alpha Engine · Data: CoinGecko · Deribit · Binance WS · Alternative.me · CryptoCompare<br/>
  <a href="https://power.trade" target="_blank">power.trade</a> · <a href="https://power.trade/en/market-insights" target="_blank">Market Insights</a> · Not Financial Advice
</div>

</div><!-- /app -->

<!-- ═══════════════════════════════════════════════════════════════ -->
<!--  JAVASCRIPT ENGINE                                             -->
<!-- ═══════════════════════════════════════════════════════════════ -->
<script>
// ═══ LOGIN / AUTH ═══════════════════════════════════════════════
function doLogin(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value.trim();
  if(u==='admin'&&p==='admin'){
    localStorage.setItem('kaito_session',JSON.stringify({user:u,ts:Date.now()}));
    showApp();
  } else {
    document.getElementById('login-error').textContent='Invalid credentials. Try admin / admin';
  }
}
function showApp(){
  const ls=document.getElementById('login-screen');
  ls.classList.add('hidden');
  setTimeout(()=>{ls.style.display='none'},400);
  document.getElementById('app').style.display='block';
  initApp();
}
function checkSession(){
  const s=localStorage.getItem('kaito_session');
  if(s){try{const d=JSON.parse(s);if(Date.now()-d.ts<86400000*7){showApp();return;}}catch(e){}}
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  document.getElementById('login-user').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-pass').focus()});
}

// ═══ MODE STATE ═══════════════════════════════════════════════
let currentMode='spot'; // 'spot' or 'options'

function setMode(mode){
  currentMode=mode;
  document.getElementById('mode-spot').classList.toggle('active',mode==='spot');
  document.getElementById('mode-options').classList.toggle('active',mode==='options');
  // Show/hide header stats based on mode
  const ivStat=document.getElementById('hdr-iv-stat');
  const skewStat=document.getElementById('hdr-skew-stat');
  const skewDiv=document.getElementById('hdr-div-skew');
  if(mode==='spot'){
    if(ivStat)ivStat.style.display='none';
    if(skewStat)skewStat.style.display='none';
    if(skewDiv)skewDiv.style.display='none';
  } else {
    if(ivStat)ivStat.style.display='';
    if(skewStat)skewStat.style.display='';
    if(skewDiv)skewDiv.style.display='';
  }
  buildTabs();
  buildPanels();
  renderAll();
}

// ─── TOKEN REGISTRY ──────────────────────────────────────────────
const R=[];
const raw=[
["BTC","Bitcoin","L1",1920e9,98450],["ETH","Ethereum","L1",462e9,3850],["SOL","Solana","L1",92e9,198],
["XRP","Ripple","L1",72e9,1.24],["BNB","BNB","L1",85e9,580],["DOGE","Dogecoin","Meme",28e9,.195],
["ADA","Cardano","L1",18e9,.52],["AVAX","Avalanche","L1",14e9,35.4],["DOT","Polkadot","L1",8.5e9,6.2],
["LINK","Chainlink","Oracle",11e9,18.4],["SUI","Sui","L1",9.2e9,3.45],["TON","Toncoin","L1",12e9,4.85],
["SHIB","Shiba Inu","Meme",9.8e9,.0000165],["PEPE","Pepe","Meme",5.4e9,.0000128],["LTC","Litecoin","L1",6.8e9,92],
["ARB","Arbitrum","L2",3.2e9,.82],["OP","Optimism","L2",2.8e9,2.15],["NEAR","NEAR","L1",4.5e9,4.2],
["INJ","Injective","DeFi",2.6e9,28.5],["FIL","Filecoin","DePIN",3.1e9,5.4],
["MATIC","Polygon","L2",3.8e9,.38],["TAO","Bittensor","AI",3.4e9,480],
["AAVE","Aave","DeFi",4.2e9,285],["ATOM","Cosmos","L1",3.1e9,8.2],
["RUNE","THORChain","DeFi",1.8e9,5.4],["UNI","Uniswap","DeFi",6.2e9,10.4],
["LDO","Lido","DeFi",1.6e9,1.82],["TIA","Celestia","Modular",1.9e9,4.85],
["FET","ASI Alliance","AI",2.8e9,1.65],["RNDR","Render","AI/DePIN",3.6e9,7.2],
["APT","Aptos","L1",3.9e9,8.5],["TRX","TRON","L1",10e9,.115],
["ICP","Internet Computer","L1",3.8e9,8.1],["ENA","Ethena","DeFi",1.2e9,.72],
["WIF","dogwifhat","Meme",1.8e9,1.82],["HYPE","Hyperliquid","DeFi/Perp",5.4e9,18.5],
["ONDO","Ondo","RWA",2.4e9,1.72],["PENDLE","Pendle","DeFi",900e6,5.85],
["JUP","Jupiter","DeFi",1.4e9,1.02],["MKR","Maker","DeFi",5.6e9,1420],
["CRV","Curve","DeFi",600e6,.48],["HBAR","Hedera","L1",7.2e9,.195],
["KAS","Kaspa","L1",3.2e9,.128],["FTM","Sonic","L1",2.2e9,.78],
["WLD","Worldcoin","AI",1.4e9,1.95],["TRUMP","Off.Trump","PolitiFi",3.2e9,16.2],
["VIRTUAL","Virtuals","AI",1.8e9,1.85],["EIGEN","EigenLayer","Restaking",800e6,2.45],
["XLM","Stellar","L1",8.6e9,.285],["GRT","The Graph","Infra",2.2e9,.228],
["RAY","Raydium","DeFi",800e6,3.45],["XMR","Monero","Privacy",3.8e9,210],
["BCH","Bitcoin Cash","L1",6.8e9,345],["ETC","Eth Classic","L1",3.8e9,26.5],
["POPCAT","Popcat","Meme",800e6,.82],["GOAT","Goatseus","AI/Meme",400e6,.42],
["FARTCOIN","Fartcoin","Meme",400e6,.42],["PAXG","PAX Gold","RWA",600e6,2920],
["STX","Stacks","BTC L2",2.1e9,1.45],["IMX","Immutable","Gaming",1.4e9,.92],
["BONK","Bonk","Meme",1.2e9,.0000195],["PENGU","PudgyPenguins","Meme/NFT",1.2e9,.019],
["MORPHO","Morpho","DeFi",400e6,2.85],["ZK","ZKsync","L2",600e6,.165],
["PYTH","Pyth","Oracle",1.1e9,.295],["SEI","Sei","L1",1.1e9,.38],
["PTF","PowerTrade","Exchange",5e6,.0045],
];
raw.forEach((r,i)=>R.push({s:r[0],n:r[1],cat:r[2],mc:r[3],p:r[4]}));

// ─── UTILITIES ───────────────────────────────────────────────────
const sr=(s,n)=>(Math.sin(s*n*13.37+n*7.13+s*.91)*0.5+0.5);
const fP=v=>v>=0?`+${v.toFixed(2)}%`:`${v.toFixed(2)}%`;
const fPr=v=>v>=1e3?`$${(v/1e3).toFixed(2)}k`:v>=1?`$${v.toFixed(2)}`:v>=.01?`$${v.toFixed(4)}`:v>=.0001?`$${v.toFixed(6)}`:`$${v.toFixed(8)}`;
const fmt=v=>v>=1e12?`$${(v/1e12).toFixed(2)}T`:v>=1e9?`$${(v/1e9).toFixed(2)}B`:v>=1e6?`$${(v/1e6).toFixed(2)}M`:v>=1e3?`$${(v/1e3).toFixed(1)}K`:`$${v.toFixed(0)}`;
const cCls=v=>v>=0?'up':'dn';
const fPct=v=>(v>=0?'+':'')+v.toFixed(1)+'%';

let D=[], selectedAsset=null, tmMode="mindshare", glTab="gain", bubTF="24h", tblTF="24h", tSortK="conv", tSortD="desc",
    sigFilter="all", flowFilter="all", flowFilter2="all", stratFilter="all", catFilter="All";

// ─── DATA ENGINE ─────────────────────────────────────────────────
function gen(){
  D=R.map((t,i)=>{
    const s=i*31+t.s.charCodeAt(0);
    const currentIV = sr(s,15)*65+28;
    const rv30 = currentIV*(0.75+sr(s,19)*0.45);
    const ivChg = (currentIV-rv30)*0.15;
    const ivRank = Math.min(100,Math.max(0,Math.floor(((currentIV-28)/(93-28))*100)));
    const skew25d = +((sr(s,22)-0.52)*12).toFixed(1);
    const gammaExp = (sr(s,21)-0.49) * t.mc * 0.04;
    const lsRatio = +(sr(s,17)*1.6+.45).toFixed(2);
    const fund = +((sr(s,12)-.5)*.065).toFixed(4);
    const ivDisl = Math.abs(ivRank-50)/50*40;
    const skewSig = Math.min(20,Math.abs(skew25d)*2);
    const squeezeSig = fund > 0.04 || fund < -0.04 ? 20 : Math.abs(fund)*300;
    const gexSig = gammaExp < 0 ? 15 : 5;
    const ivRvDisl = Math.abs(currentIV-rv30)/rv30*5;
    const conviction = Math.min(98,Math.floor(ivDisl+skewSig+squeezeSig+gexSig+ivRvDisl+sr(s,33)*5));
    return{...t,seed:s,
      ch1h:+((sr(s,1)-.48)*8).toFixed(2),
      ch24h:+((sr(s,2)-.45)*18).toFixed(2),
      ch7d:+((sr(s,3)-.42)*35).toFixed(2),
      ch30d:+((sr(s,4)-.38)*60).toFixed(2),
      vol:t.mc*sr(s,5)*.15+t.mc*.02,
      rsi:Math.floor(sr(s,6)*60+20),
      sent:Math.floor(sr(s,7)*80+10),
      ms:t.s==="BTC"?18.5+sr(s,8)*4:t.s==="ETH"?11.2+sr(s,9)*2:sr(s,11)*4+.1,
      fund, tox:+sr(s,13).toFixed(2), liq:sr(s,14)*(t.mc*.003),
      oi:t.mc*sr(s,16)*.08, lsRatio,
      iv:+currentIV.toFixed(1), rv30:+rv30.toFixed(1),
      ivChg:+ivChg.toFixed(1), ivRank, ivRv:+(currentIV-rv30).toFixed(1),
      skew25d, gammaExp, conviction,
      // Second-order Greeks (new)
      vanna:0, charm:0, netVanna:0, netCharm:0
    };
  });
}
gen();

// ═══════════════════════════════════════════════════════════════════
// CALCULATIONS: VANNA & CHARM — Second-Order Dealer Exposure
// ═══════════════════════════════════════════════════════════════════

// Black-Scholes helpers
function normPDF(x){ return Math.exp(-0.5*x*x)/Math.sqrt(2*Math.PI); }
function normCDF(x){ const t=1/(1+0.2316419*Math.abs(x));const d=0.3989422802*Math.exp(-x*x/2);const p=d*t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274))));return x>0?1-p:p; }

// Vanna = dDelta/dSigma = (d1 * d2 * vega) / (S * sigma)
// For ATM approximation: Vanna ≈ -d2/sigma * N'(d1) * sqrt(T)
function calcOptionVanna(S, K, T, sigma, r=0){
  if(T<=0||sigma<=0)return 0;
  const d1=(Math.log(S/K)+(r+sigma*sigma/2)*T)/(sigma*Math.sqrt(T));
  const d2=d1-sigma*Math.sqrt(T);
  const vega=S*normPDF(d1)*Math.sqrt(T);
  return -vega*d2/(S*sigma);
}

// Charm = dDelta/dT (time decay of delta)
// Charm ≈ -N'(d1) * (2*r*T - d2*sigma*sqrt(T)) / (2*T*sigma*sqrt(T))
function calcOptionCharm(S, K, T, sigma, r=0, isCall=true){
  if(T<=0||sigma<=0)return 0;
  const sqrtT=Math.sqrt(T);
  const d1=(Math.log(S/K)+(r+sigma*sigma/2)*T)/(sigma*sqrtT);
  const d2=d1-sigma*sqrtT;
  const npd1=normPDF(d1);
  // For calls: charm = -npd1 * (2*r*T - d2*sigma*sqrtT) / (2*T*sigma*sqrtT)
  const charm=-npd1*(2*r*T-d2*sigma*sqrtT)/(2*T*sigma*sqrtT);
  return isCall?charm:charm; // same formula, sign flips via delta relationship
}

// Net Vanna / Net Charm across OI (aggregated dealer exposure)
// Assumes retail long wings, dealers short wings (inverse positions)
function calcNetVanna(sym){
  const t=D.find(d=>d.s===sym);if(!t)return 0;
  const S=t.p, sigma=t.iv/100, oi=t.oi;
  if(!S||!sigma||!oi)return 0;
  // Simulate across strike range (5 strike levels)
  const dtes=[7,14,30,60,90];
  let totalVanna=0;
  for(const dte of dtes){
    const T=dte/365;
    const weight=dte<=14?0.35:dte<=30?0.30:dte<=60?0.20:0.15;
    const strikes=[S*0.90,S*0.95,S,S*1.05,S*1.10];
    for(const K of strikes){
      const v=calcOptionVanna(S,K,T,sigma);
      // Dealer side: assume dealers short wings, long ATM
      const dealerSign=(Math.abs(K-S)/S<0.03)?-1:1; // dealers short ATM vanna, long wing vanna
      const strikeOI=oi*weight*0.2; // distribute OI
      totalVanna += v * strikeOI * dealerSign;
    }
  }
  return totalVanna;
}

function calcNetCharm(sym){
  const t=D.find(d=>d.s===sym);if(!t)return 0;
  const S=t.p, sigma=t.iv/100, oi=t.oi;
  if(!S||!sigma||!oi)return 0;
  const dtes=[7,14,30,60,90];
  let totalCharm=0;
  for(const dte of dtes){
    const T=dte/365;
    const weight=dte<=14?0.35:dte<=30?0.30:dte<=60?0.20:0.15;
    const strikes=[S*0.90,S*0.95,S,S*1.05,S*1.10];
    for(const K of strikes){
      const c=calcOptionCharm(S,K,T,sigma,0,K>=S);
      const dealerSign=(Math.abs(K-S)/S<0.03)?-1:1;
      const strikeOI=oi*weight*0.2;
      totalCharm += c * strikeOI * dealerSign;
    }
  }
  return totalCharm;
}

// Update Greeks on all tokens
function updateSecondOrderGreeks(){
  const optionsAssets=['BTC','ETH','SOL','BNB','AVAX','LINK','DOGE','AAVE','UNI','INJ'];
  for(const sym of optionsAssets){
    const t=D.find(d=>d.s===sym);if(!t)continue;
    t.netVanna=calcNetVanna(sym);
    t.netCharm=calcNetCharm(sym);
    // Per-option single ATM metrics (for display)
    const T30=30/365;
    t.vanna=calcOptionVanna(t.p,t.p,T30,t.iv/100);
    t.charm=calcOptionCharm(t.p,t.p,T30,t.iv/100);
  }
}

// ═══════════════════════════════════════════════════════════════════
// DEALER HEDGING SIMULATOR
// ═══════════════════════════════════════════════════════════════════
function simulateDealerHedge(spotShiftPct, volShiftPts, timeStep){
  const btc=D.find(d=>d.s==='BTC');const eth=D.find(d=>d.s==='ETH');
  if(!btc||!eth) return {btcHedge:0,ethHedge:0,totalUSD:0,direction:'—',explain:''};

  const assets=[btc,eth];
  let totalHedgeUSD=0;
  const results=[];

  for(const t of assets){
    const S=t.p;
    const sigma=t.iv/100;
    const oi=t.oi;
    const T=30/365; // current 30D tenor

    // Current aggregate delta (simplified: sum of ATM option deltas * OI)
    const currentDelta=calcAggregateDelta(S,sigma,T,oi);

    // New parameters
    const newS=S*(1+spotShiftPct/100);
    const newSigma=Math.max(0.05,(sigma*100+volShiftPts)/100);
    const newT=timeStep==='weekend'?Math.max(0.001,T-3/365):Math.max(0.001,T-1/365);

    // Simulated aggregate delta
    const simDelta=calcAggregateDelta(newS,newSigma,newT,oi);

    // Hedging requirement = difference in delta * underlying price
    const deltaChange=simDelta-currentDelta;
    const hedgeUSD=deltaChange*newS;
    totalHedgeUSD+=hedgeUSD;

    results.push({sym:t.s,hedgeUSD,deltaChange,currentDelta,simDelta});
  }

  const direction=totalHedgeUSD>0?'BUY':'SELL';
  const explain=`If BTC ${spotShiftPct>=0?'rallies':'drops'} ${Math.abs(spotShiftPct)}% and Vol ${volShiftPts>=0?'spikes':'crushes'} ${Math.abs(volShiftPts)} pts over ${timeStep==='weekend'?'a weekend':'24h'}, dealers will be forced to ${direction} ~${fmt(Math.abs(totalHedgeUSD))} of Spot across BTC+ETH to remain delta-neutral.`;

  return {btcHedge:results[0]?.hedgeUSD||0, ethHedge:results[1]?.hedgeUSD||0, totalUSD:totalHedgeUSD, direction, explain, results};
}

function calcAggregateDelta(S, sigma, T, oi){
  if(T<=0||sigma<=0) return 0;
  const strikes=[S*0.90,S*0.95,S,S*1.05,S*1.10];
  let totalDelta=0;
  for(const K of strikes){
    const d1=(Math.log(S/K)+(sigma*sigma/2)*T)/(sigma*Math.sqrt(T));
    const callDelta=normCDF(d1);
    const putDelta=callDelta-1;
    // Assume roughly equal call/put OI at each strike
    const strikeOI=oi*0.1;
    // Dealer short calls, long puts at wings; opposite ATM
    const isATM=Math.abs(K-S)/S<0.03;
    const dealerCallDelta=isATM?-callDelta*strikeOI:callDelta*strikeOI*0.3;
    const dealerPutDelta=isATM?-putDelta*strikeOI:putDelta*strikeOI*0.3;
    totalDelta+=dealerCallDelta+dealerPutDelta;
  }
  return totalDelta;
}


// ═══════════════════════════════════════════════════════════════════
// LIVE DATA SERVICE v3.0 — Multi-Source Architecture
// ═══════════════════════════════════════════════════════════════════
const LiveData = {
  src: {
    coingecko:  { id:'coingecko',  name:'CoinGecko',      url:'api.coingecko.com',  type:'REST',  interval:60,  connected:false, lastSuccess:0, lastAttempt:0, lastError:null, fetchCount:0, errorCount:0, provides:'Prices, MCap, Volume, % Changes (60+ tokens)' },
    deribit:    { id:'deribit',    name:'Deribit',         url:'deribit.com',        type:'REST',  interval:30,  connected:false, lastSuccess:0, lastAttempt:0, lastError:null, fetchCount:0, errorCount:0, provides:'Options IV, Term Structure, Skew, OI, Funding, Flow' },
    binanceWs:  { id:'binanceWs',  name:'Binance WS',     url:'stream.binance.com', type:'WS',    interval:0,   connected:false, lastSuccess:0, lastAttempt:0, lastError:null, fetchCount:0, errorCount:0, provides:'Real-time prices (sub-second), 24h Volume' },
    fng:        { id:'fng',        name:'Alternative.me',  url:'api.alternative.me',  type:'REST',  interval:300, connected:false, lastSuccess:0, lastAttempt:0, lastError:null, fetchCount:0, errorCount:0, provides:'Fear & Greed Index' },
    news:       { id:'news',       name:'CryptoCompare',   url:'min-api.cryptocompare.com', type:'REST', interval:180, connected:false, lastSuccess:0, lastAttempt:0, lastError:null, fetchCount:0, errorCount:0, provides:'Live crypto news articles' },
  },
  fieldTs: {},
  errors: [],
  fgIndex: null,
  ws: null,
  wsReconnects: 0,
  termStructureData: {},

  cgMap: {
    'BTC':'bitcoin','ETH':'ethereum','SOL':'solana','XRP':'ripple',
    'BNB':'binancecoin','DOGE':'dogecoin','ADA':'cardano',
    'AVAX':'avalanche-2','DOT':'polkadot','LINK':'chainlink',
    'SUI':'sui','TON':'the-open-network','SHIB':'shiba-inu',
    'PEPE':'pepe','LTC':'litecoin','ARB':'arbitrum',
    'OP':'optimism','NEAR':'near','INJ':'injective-protocol',
    'FIL':'filecoin','MATIC':'matic-network','TAO':'bittensor',
    'AAVE':'aave','ATOM':'cosmos','RUNE':'thorchain',
    'UNI':'uniswap','LDO':'lido-dao','TIA':'celestia',
    'FET':'artificial-superintelligence-alliance','RNDR':'render-token',
    'APT':'aptos','TRX':'tron','ICP':'internet-computer',
    'ENA':'ethena','WIF':'dogwifcoin','HYPE':'hyperliquid',
    'ONDO':'ondo-finance','PENDLE':'pendle',
    'JUP':'jupiter-exchange-solana','MKR':'maker',
    'CRV':'curve-dao-token','HBAR':'hedera-hashgraph',
    'KAS':'kaspa','FTM':'fantom','WLD':'worldcoin-wld',
    'TRUMP':'official-trump','VIRTUAL':'virtual-protocol',
    'EIGEN':'eigenlayer','XLM':'stellar','GRT':'the-graph',
    'RAY':'raydium','XMR':'monero','BCH':'bitcoin-cash',
    'ETC':'ethereum-classic','POPCAT':'popcat',
    'GOAT':'goatseus-maximus','FARTCOIN':'fartcoin',
    'PAXG':'pax-gold','STX':'blockstack','IMX':'immutable-x',
    'BONK':'bonk','PENGU':'pudgy-penguins',
    'MORPHO':'morpho','ZK':'zksync','PYTH':'pyth-network',
    'SEI':'sei-network','PTF':'powertrade-fuel'
  },
  _revMap: null,
  get revMap() { if(!this._revMap){this._revMap={};for(const[s,id]of Object.entries(this.cgMap))this._revMap[id]=s;}return this._revMap; },

  parseExpiry(exp) {
    const months={JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11};
    const m=exp.match(/^(\d+)([A-Z]+)(\d+)$/);
    if(!m)return new Date();
    return new Date(2000+parseInt(m[3]),months[m[2]]||0,parseInt(m[1]),8,0,0);
  },
  getDTE(exp) { return Math.max(0,Math.ceil((this.parseExpiry(exp)-Date.now())/86400000)); },
  stampField(sym, field) {
    if(!this.fieldTs[sym]) this.fieldTs[sym]={};
    this.fieldTs[sym][field]=Date.now();
  },
  getFieldAge(sym, field) {
    const ts=this.fieldTs[sym]?.[field];
    return ts ? Date.now()-ts : Infinity;
  },
  logError(sourceId, msg) {
    const entry={source:sourceId, msg, time:Date.now()};
    this.errors.unshift(entry);
    if(this.errors.length>50) this.errors.length=50;
    this.src[sourceId].lastError=msg;
    this.src[sourceId].errorCount++;
  },
  clearErrors() { this.errors=[]; },
  ageStr(ms) {
    if(ms===Infinity||ms<=0)return'never';
    const s=Math.floor(ms/1000);
    if(s<60)return s+'s';
    if(s<3600)return Math.floor(s/60)+'m '+s%60+'s';
    return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';
  },
  freshnessColor(ms) {
    if(ms===Infinity)return'var(--t5)';
    if(ms<60000)return'var(--green)';
    if(ms<300000)return'var(--amber)';
    return'var(--red)';
  },

  // ═══ FETCH: CoinGecko ═════════════════════════════════════════
  async fetchMarkets() {
    const s=this.src.coingecko; s.lastAttempt=Date.now(); s.fetchCount++;
    try {
      const ids=Object.values(this.cgMap).join(',');
      const r=await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&per_page=250&page=1&sparkline=false&price_change_percentage=1h%2C24h%2C7d%2C30d`);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      if(!Array.isArray(data)||data.length===0) throw new Error('Empty response');
      this.mergeMarketData(data);
      s.connected=true; s.lastSuccess=Date.now(); s.lastError=null;
      console.log(`[LiveData] CoinGecko: ${data.length} assets`);
      return true;
    } catch(e) {
      s.connected=false; this.logError('coingecko',e.message);
      return false;
    }
  },

  async fetchFearGreed() {
    const s=this.src.fng; s.lastAttempt=Date.now(); s.fetchCount++;
    try {
      const r=await fetch('https://api.alternative.me/fng/?limit=1');
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      if(!data.data||!data.data[0]) throw new Error('No data');
      this.fgIndex=parseInt(data.data[0].value);
      s.connected=true; s.lastSuccess=Date.now(); s.lastError=null;
      D.forEach(d=>{ d.sent=this.fgIndex; this.stampField(d.s,'sent'); });
      return this.fgIndex;
    } catch(e) {
      s.connected=false; this.logError('fng',e.message);
      return null;
    }
  },

  async fetchDeribitOptions(currency) {
    const s=this.src.deribit; s.lastAttempt=Date.now(); s.fetchCount++;
    try {
      const r=await fetch(`https://deribit.com/api/v2/public/get_book_summary_by_currency?currency=${currency}&kind=option`);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      if(!data.result||!data.result.length) throw new Error('No instruments');
      this.processOptionsData(currency,data.result);
      s.connected=true; s.lastSuccess=Date.now(); s.lastError=null;
      return true;
    } catch(e) {
      s.connected=false; this.logError('deribit',e.message);
      return false;
    }
  },

  async fetchDeribitFunding() {
    try {
      const results=await Promise.allSettled(
        ['BTC-PERPETUAL','ETH-PERPETUAL'].map(inst=>
          fetch(`https://deribit.com/api/v2/public/ticker?instrument_name=${inst}`).then(r=>r.ok?r.json():null))
      );
      const symMap={'BTC-PERPETUAL':'BTC','ETH-PERPETUAL':'ETH'};
      for(const res of results){
        if(res.status!=='fulfilled'||!res.value?.result) continue;
        const tick=res.value.result;
        const sym=symMap[tick.instrument_name]; if(!sym) continue;
        const rate=tick.funding_8h||0;
        const d=D.find(x=>x.s===sym);
        if(d){ d.fund=+rate.toFixed(6); this.stampField(sym,'fund'); }
      }
    } catch(e) { this.logError('deribit','Funding: '+e.message); }
  },

  async fetchDeribitTrades(currency) {
    try {
      const r=await fetch(`https://deribit.com/api/v2/public/get_last_trades_by_currency?currency=${currency}&kind=option&count=30`);
      if(!r.ok) return;
      const data=await r.json();
      if(!data.result?.trades) return;
      const newFlows=[];
      for(const t of data.result.trades){
        const parts=t.instrument_name.split('-');
        if(parts.length<4) continue;
        const asset=parts[0],expiry=parts[1],strike=parseFloat(parts[2]),type=parts[3]==='C'?'CALL':'PUT';
        const contracts=Math.abs(t.amount||0);
        const premium=Math.abs(contracts*t.price*(t.index_price||0));
        const age=Math.floor((Date.now()-t.timestamp)/1000);
        const isSweep=contracts>5&&t.liquidity==='T';
        const isBlock=t.block_trade_id!=null;
        newFlows.push({
          asset,type,ot:isBlock?'BLOCK':isSweep?'SWEEP':t.direction==='buy'?'BUY':'SELL',
          isSweep:isSweep||isBlock, contracts:+contracts.toFixed(1),
          strike, premium:+premium.toFixed(0), expiry, venue:'Deribit',
          age, timestamp:t.timestamp, isLarge:premium>50000,
          isBull:(type==='CALL'&&t.direction==='buy')||(type==='PUT'&&t.direction==='sell'),
          spreadType:null,spreadLabel:null,linkedIdx:-1,intent:null,
          iv:t.iv?+(t.iv*100).toFixed(1):null, isLive:true
        });
      }
      const keepFlows=FLOWS.filter(f=>!f.isLive);
      FLOWS.length=0;
      FLOWS.push(...newFlows,...keepFlows);
      FLOWS.sort((a,b)=>a.age-b.age);
      if(FLOWS.length>80)FLOWS.length=80;
      detectComplexSpreads();
    } catch(e) { /* silent */ }
  },

  async fetchNews() {
    const s=this.src.news; s.lastAttempt=Date.now(); s.fetchCount++;
    try {
      const r=await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN&sortOrder=latest');
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      if(!data.Data||!Array.isArray(data.Data)) throw new Error('No articles');
      const articles=data.Data.slice(0,15).map(n=>{
        const tags=[];
        if(n.categories){
          const cats=n.categories.toUpperCase().split('|');
          for(const c of cats){
            if(c.includes('BTC')||c.includes('BITCOIN'))tags.push('BTC');
            else if(c.includes('ETH'))tags.push('ETH');
            else if(c.includes('SOL'))tags.push('SOL');
            else if(c.includes('DEFI'))tags.push('DEFI');
            else if(c.includes('REGULATION'))tags.push('MACRO');
            else if(c.includes('EXCHANGE'))tags.push('FLOW');
          }
        }
        if(!tags.length)tags.push('MACRO');
        const ageMs=Date.now()/1000-n.published_on;
        const ageStr=ageMs<3600?`${Math.floor(ageMs/60)}m`:ageMs<86400?`${Math.floor(ageMs/3600)}h`:`${Math.floor(ageMs/86400)}d`;
        return{t:n.title,tags:tags.slice(0,3),time:ageStr,url:n.url,source:n.source};
      });
      if(articles.length>0){
        NEWS.length=0; NEWS.push(...articles);
        renderNews("news-dash"); renderNews("news-full");
      }
      s.connected=true; s.lastSuccess=Date.now(); s.lastError=null;
      return true;
    } catch(e) {
      s.connected=false; this.logError('news',e.message);
      return false;
    }
  },

  // ═══ WEBSOCKET: Binance ══════════════════════════════════════
  connectWS() {
    if(this.ws) try{this.ws.close();}catch(e){}
    const s=this.src.binanceWs; s.lastAttempt=Date.now(); s.fetchCount++;
    try {
      const streams=['btcusdt','ethusdt','solusdt','bnbusdt','dogeusdt','avaxusdt',
        'linkusdt','adausdt','dotusdt','xrpusdt','arbusdt','uniusdt',
        'ltcusdt','maticusdt','nearusdt','injusdt','aaveusdt','suiusdt',
        'aptusdt','trxusdt','shibusdt','atomusdt','filusdt','icpusdt',
        'xlmusdt','hbarusdt','ftmusdt','etcusdt','bchusdt'
      ].map(x=>`${x}@miniTicker`).join('/');
      this.ws=new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
      const symMap={BTCUSDT:'BTC',ETHUSDT:'ETH',SOLUSDT:'SOL',BNBUSDT:'BNB',
        DOGEUSDT:'DOGE',AVAXUSDT:'AVAX',LINKUSDT:'LINK',ADAUSDT:'ADA',
        DOTUSDT:'DOT',XRPUSDT:'XRP',ARBUSDT:'ARB',UNIUSDT:'UNI',
        LTCUSDT:'LTC',MATICUSDT:'MATIC',NEARUSDT:'NEAR',INJUSDT:'INJ',
        AAVEUSDT:'AAVE',SUIUSDT:'SUI',APTUSDT:'APT',TRXUSDT:'TRX',
        SHIBUSDT:'SHIB',ATOMUSDT:'ATOM',FILUSDT:'FIL',
        ICPUSDT:'ICP',XLMUSDT:'XLM',HBARUSDT:'HBAR',
        FTMUSDT:'FTM',ETCUSDT:'ETC',BCHUSDT:'BCH'};
      this.ws.onopen=()=>{
        s.connected=true; s.lastSuccess=Date.now(); s.lastError=null;
        this.wsReconnects=0; this.updateStatus();
      };
      this.ws.onmessage=(event)=>{
        try{
          const msg=JSON.parse(event.data);
          const d=msg.data; if(!d?.s)return;
          const sym=symMap[d.s]; if(!sym)return;
          const price=parseFloat(d.c); const vol24h=parseFloat(d.q);
          if(isNaN(price)||price<=0)return;
          const rEntry=R.find(r=>r.s===sym);
          if(rEntry) rEntry.p=price;
          const dEntry=D.find(x=>x.s===sym);
          if(dEntry){
            dEntry.p=price; this.stampField(sym,'p');
            if(vol24h>0){dEntry.vol=vol24h; this.stampField(sym,'vol');}
          }
          // Update header prices in real time
          if(sym==='BTC'){const el=document.getElementById('h-btcprice');if(el)el.textContent=fPr(price);}
          if(sym==='ETH'){const el=document.getElementById('h-ethprice');if(el)el.textContent=fPr(price);}
          s.lastSuccess=Date.now();
        }catch(e){}
      };
      this.ws.onclose=()=>{
        s.connected=false; this.updateStatus();
        if(this.wsReconnects<10){
          const delay=Math.min(30000,2000*Math.pow(2,this.wsReconnects));
          this.wsReconnects++;
          setTimeout(()=>this.connectWS(),delay);
        }
      };
      this.ws.onerror=()=>{ this.logError('binanceWs','WebSocket error'); };
    } catch(e) { this.logError('binanceWs',e.message); }
  },

  mergeMarketData(cgData) {
    const rev=this.revMap;
    for(const coin of cgData){
      const sym=rev[coin.id]; if(!sym) continue;
      const rEntry=R.find(r=>r.s===sym);
      if(rEntry){ rEntry.mc=coin.market_cap||rEntry.mc; rEntry.p=coin.current_price||rEntry.p; }
      const d=D.find(x=>x.s===sym);
      if(d){
        if(coin.current_price){d.p=coin.current_price; this.stampField(sym,'p');}
        if(coin.market_cap){d.mc=coin.market_cap; this.stampField(sym,'mc');}
        if(coin.price_change_percentage_1h_in_currency!=null){d.ch1h=+coin.price_change_percentage_1h_in_currency.toFixed(2); this.stampField(sym,'ch1h');}
        if(coin.price_change_percentage_24h_in_currency!=null){d.ch24h=+coin.price_change_percentage_24h_in_currency.toFixed(2); this.stampField(sym,'ch24h');}
        if(coin.price_change_percentage_7d_in_currency!=null){d.ch7d=+coin.price_change_percentage_7d_in_currency.toFixed(2); this.stampField(sym,'ch7d');}
        if(coin.price_change_percentage_30d_in_currency!=null){d.ch30d=+coin.price_change_percentage_30d_in_currency.toFixed(2); this.stampField(sym,'ch30d');}
        if(coin.total_volume){d.vol=coin.total_volume; this.stampField(sym,'vol');}
      }
    }
  },

  processOptionsData(currency, instruments) {
    if(!instruments?.length) return;
    const underlying=instruments.find(i=>i.underlying_price>0)?.underlying_price;
    if(!underlying) return;
    const parsed=instruments.filter(i=>i.mark_iv>0).map(inst=>{
      const parts=inst.instrument_name.split('-');
      if(parts.length<4) return null;
      return{...inst,expiry:parts[1],strike:parseFloat(parts[2]),type:parts[3],
        moneyness:Math.abs(parseFloat(parts[2])-underlying)/underlying};
    }).filter(Boolean);
    if(!parsed.length) return;

    const atm=parsed.filter(x=>x.moneyness<0.05);
    const atmIV=atm.length?atm.reduce((s,x)=>s+x.mark_iv,0)/atm.length:null;
    const totalOI=parsed.reduce((s,x)=>s+(x.open_interest||0),0)*underlying;
    const otmPuts=parsed.filter(x=>x.type==='P'&&x.moneyness>0.05&&x.moneyness<0.20);
    const otmCalls=parsed.filter(x=>x.type==='C'&&x.moneyness>0.05&&x.moneyness<0.20);
    const avgPutIV=otmPuts.length?otmPuts.reduce((s,x)=>s+x.mark_iv,0)/otmPuts.length:null;
    const avgCallIV=otmCalls.length?otmCalls.reduce((s,x)=>s+x.mark_iv,0)/otmCalls.length:null;
    const skew=(avgCallIV!=null&&avgPutIV!=null)?+((avgCallIV-avgPutIV)).toFixed(1):null;

    const byExpiry={};
    for(const inst of parsed){ if(!byExpiry[inst.expiry])byExpiry[inst.expiry]=[]; byExpiry[inst.expiry].push(inst); }
    const termData=[];
    for(const[exp,insts]of Object.entries(byExpiry)){
      const dte=this.getDTE(exp); if(dte<=0) continue;
      const nearATM=insts.filter(x=>x.moneyness<0.10); if(!nearATM.length) continue;
      const iv=nearATM.reduce((s,x)=>s+x.mark_iv,0)/nearATM.length;
      termData.push({expiry:exp,dte,iv:+iv.toFixed(1),oi:insts.reduce((s,x)=>s+(x.open_interest||0),0)});
    }
    termData.sort((a,b)=>a.dte-b.dte);
    this.termStructureData[currency]=termData;

    const d=D.find(x=>x.s===currency);
    if(d){
      if(atmIV!=null){d.iv=+atmIV.toFixed(1); d.ivRank=Math.min(100,Math.max(0,Math.floor(((d.iv-28)/(93-28))*100))); d.ivRv=+(d.iv-d.rv30).toFixed(1); this.stampField(currency,'iv'); this.stampField(currency,'ivRank');}
      if(skew!=null){d.skew25d=skew; this.stampField(currency,'skew25d');}
      if(totalOI>0){d.oi=totalOI; this.stampField(currency,'oi');}
    }
  },

  get activeCount(){ return Object.values(this.src).filter(s=>s.connected).length; },
  get totalCount(){ return Object.keys(this.src).length; },
  get status(){
    const a=this.activeCount; const t=this.totalCount;
    if(a===0)return'offline'; if(a===t)return'live'; return'degraded';
  },
  updateStatus() { this.renderHeaderStatus(); },
  renderHeaderStatus() {
    const el=document.getElementById('live-status'); if(!el) return;
    const colors={live:'var(--green)',degraded:'var(--amber)',offline:'var(--red)'};
    const labels={live:'LIVE DATA',degraded:'PARTIAL',offline:'OFFLINE'};
    const c=colors[this.status]||'var(--t4)';
    el.innerHTML=`
      <div style="display:flex;align-items:center;gap:4px;font-size:8px;font-weight:700;letter-spacing:.04em;color:${c}">
        <div style="width:5px;height:5px;border-radius:50%;background:${c};${this.status==='live'?'box-shadow:0 0 6px '+c+';animation:blink 2s infinite':''}"></div>
        ${labels[this.status]||'…'} <span style="color:var(--t4);font-weight:400;font-size:7px">${this.activeCount}/${this.totalCount}</span>
      </div>
      <div style="display:flex;gap:3px;font-size:7px">
        ${Object.values(this.src).map(s=>`<span title="${s.name}: ${s.connected?'connected':'disconnected'}" style="color:${s.connected?'var(--green)':'var(--t5)'}">●</span>`).join('')}
      </div>`;
  },

  async refreshAll() {
    await Promise.allSettled([
      this.fetchMarkets(),
      this.fetchDeribitOptions('BTC'),
      this.fetchDeribitOptions('ETH'),
      this.fetchDeribitFunding(),
      this.fetchDeribitTrades('BTC'),
      this.fetchDeribitTrades('ETH'),
      this.fetchFearGreed(),
      this.fetchNews()
    ]);
    this.updateStatus();
    updateSecondOrderGreeks();
    renderAll();
  },

  async start() {
    console.log('[LiveData] Starting live data service v3...');
    this.renderHeaderStatus();
    await this.refreshAll();
    setInterval(()=>this.fetchMarkets().then(()=>{this.updateStatus();renderAll();}),60000);
    setInterval(()=>{
      Promise.allSettled([
        this.fetchDeribitOptions('BTC'),this.fetchDeribitOptions('ETH'),
        this.fetchDeribitFunding(),
        this.fetchDeribitTrades('BTC'),this.fetchDeribitTrades('ETH')
      ]).then(()=>{this.updateStatus();updateSecondOrderGreeks();});
    },30000);
    setInterval(()=>this.fetchFearGreed().then(()=>this.updateStatus()),300000);
    setInterval(()=>this.fetchNews(),180000);
    this.connectWS();
    setInterval(()=>this.updateStatus(),5000);
    console.log('[LiveData] Service started — all sources initialized');
  }
};


// ═══ FLOWS / REGIME / SIGNALS ═══════════════════════════════════
const FLOWS=[];
function generateFlows(){
  const assets=["BTC","ETH","SOL","BNB","AVAX","LINK","DOGE","ARB","UNI","MATIC","INJ","AAVE","TIA","ENA","HYPE"];
  const expiries=["14MAR25","28MAR25","25APR25","30MAY25","27JUN25","26SEP25"];
  const types=["CALL","PUT"];
  const venues=["Deribit","OKX","Bybit","CME","PowerTrade"];
  const tradeTypes=["SWEEP","BLOCK","BUY","SELL","SPREAD","ROLL"];
  const prices={"BTC":98450,"ETH":3850,"SOL":198,"BNB":580,"AVAX":35.4,"LINK":18.4,"DOGE":.195,"ARB":.82,"UNI":10.4,"MATIC":.38,"INJ":28.5,"AAVE":285,"TIA":4.85,"ENA":.72,"HYPE":18.5};
  const now=Date.now();
  for(let i=0;i<60;i++){
    const asset=assets[Math.floor(Math.sin(i*7.13)*assets.length+assets.length)%assets.length];
    const price=prices[asset]||10;
    const type=types[i%2];
    const ot=tradeTypes[Math.floor(Math.abs(Math.sin(i*3.7))*tradeTypes.length)];
    const isSweep=ot==="SWEEP"||ot==="BLOCK";
    const contracts=Math.floor(Math.abs(Math.sin(i*2.1))*800+50);
    const strike=price*(0.85+Math.abs(Math.sin(i*1.3))*0.35);
    const premium=+(strike*contracts*(0.02+Math.abs(Math.sin(i*4.1))*0.08)).toFixed(0);
    const expiry=expiries[i%expiries.length];
    const venue=venues[i%venues.length];
    const age=Math.floor(Math.abs(Math.sin(i*5.5))*3600);
    const timestamp=now-age*1000;
    FLOWS.push({asset,type,ot,isSweep,contracts,strike,premium,expiry,venue,age,timestamp,
      isLarge:premium>50000,isBull:type==="CALL"&&ot!=="SELL"||type==="PUT"&&ot==="SELL",
      spreadType:null,spreadLabel:null,linkedIdx:-1,intent:null});
  }
  FLOWS.sort((a,b)=>a.age-b.age);
  detectComplexSpreads();
}
function detectComplexSpreads(){
  const WINDOW_MS=1000;
  for(let i=0;i<FLOWS.length;i++){
    if(FLOWS[i].spreadType) continue;
    for(let j=i+1;j<FLOWS.length;j++){
      if(FLOWS[j].spreadType) continue;
      const a=FLOWS[i], b=FLOWS[j];
      if(a.asset!==b.asset) continue;
      if(Math.abs(a.timestamp-b.timestamp)>WINDOW_MS) continue;
      const sameType=a.type===b.type;
      const sameStrike=Math.abs(a.strike-b.strike)<a.strike*0.005;
      const sameExpiry=a.expiry===b.expiry;
      let spreadType=null,label=null,intent=null;
      if(sameType&&!sameStrike&&sameExpiry){spreadType="VERTICAL";label="↕ VERTICAL";intent=a.type==="CALL"?"Bullish vertical · Defined risk":"Bearish vertical · Defined risk";}
      else if(!sameType&&sameStrike&&sameExpiry){spreadType="STRADDLE";label="⬍ STRADDLE";intent="Non-directional · Vol play";}
      else if(!sameType&&!sameStrike&&sameExpiry){spreadType="STRANGLE";label="↔ STRANGLE";intent="Wide vol play";}
      else if(sameType&&sameStrike&&!sameExpiry){spreadType="CALENDAR";label="📅 CALENDAR";intent="Vol term structure trade";}
      if(spreadType){
        a.spreadType=spreadType;a.spreadLabel=label;a.linkedIdx=j;a.intent=intent;
        b.spreadType=spreadType;b.spreadLabel=label;b.linkedIdx=i;b.intent=intent;
      }
    }
  }
}
generateFlows();

const NEWS=[
  {t:"BlackRock doubles BTC ETF holdings amid volatility compression",tags:["BTC","BULL","ETF"],time:"3m"},
  {t:"ETH IV Rank drops to 18% — options market pricing calm ahead of upgrade",tags:["ETH","VOL","CHEAP"],time:"11m"},
  {t:"SOL 25-delta skew turns positive for first time in 6 weeks",tags:["SOL","SKEW","CALL"],time:"22m"},
  {t:"BTC perpetual funding hits 0.07% on OKX — extreme leverage warning",tags:["BTC","FUNDING","RISK"],time:"35m"},
  {t:"Gamma squeeze watch: BTC approaching -$800M GEX level",tags:["BTC","GEX","RISK"],time:"48m"},
  {t:"Deribit reports record $2.8B notional in BTC calls for March 28 expiry",tags:["BTC","DERIBIT","FLOW"],time:"1h"},
  {t:"Fed minutes signal no rate cuts until Q3 — crypto vol term structure steepens",tags:["MACRO","VOL","TERM"],time:"1.5h"},
  {t:"ETH/BTC ratio breaks key level, ETH vol skew turning negative",tags:["ETH","SKEW","BEAR"],time:"2h"},
];
const tagCls={BTC:"tag-hot",ETH:"tag-info",SOL:"tag-vol",BULL:"tag-bull",BEAR:"tag-bear",RISK:"tag-bear",VOL:"tag-vol",FLOW:"tag-teal",MACRO:"tag-sym",CHEAP:"tag-bull",SKEW:"tag-vol",OI:"tag-info",DEFI:"tag-info",FUNDING:"tag-bear",GEX:"tag-vol",TERM:"tag-sym",CALL:"tag-bull",DERIBIT:"tag-sym",ETF:"tag-bull"};

// ═══ REGIME + SIGNAL + CALCULATORS ═════════════════════════════
function detectRegime(){
  const btc=D.find(t=>t.s==="BTC")||{};
  const eth=D.find(t=>t.s==="ETH")||{};
  const avgIVRank=(btc.ivRank+eth.ivRank+((D.find(t=>t.s==="SOL")||{}).ivRank||50))/3;
  const avgFund=D.slice(0,12).reduce((s,t)=>s+t.fund,0)/12;
  const avgSkew=D.slice(0,8).reduce((s,t)=>s+t.skew25d,0)/8;
  const negGEX=D.filter(t=>t.gammaExp<0).length/D.length;
  const extremeFunding = Math.abs(avgFund) > 0.03;
  const btcTrend = (btc.ch7d||0);
  if(avgIVRank<25) return{id:"compression",label:"VOL COMPRESSION",color:"var(--blue)",glow:"rgba(59,130,246,0.06)",sub:`IV at ${avgIVRank.toFixed(0)}th pctile. Options cheap. Long vol pays.`,trades:["Buy Straddles","Long Vol"],meta:[{l:"Avg IVR",v:`${avgIVRank.toFixed(0)}%`,c:"var(--blue)"},{l:"BTC IV",v:`${btc.iv?.toFixed(1)||'—'}%`,c:"var(--btc)"},{l:"Bias",v:"LONG VOL",c:"var(--blue)"}]};
  if(extremeFunding&&avgSkew>2) return{id:"squeeze",label:"SQUEEZE RISK",color:"var(--amber)",glow:"rgba(255,183,0,0.07)",sub:`Extreme funding (${(avgFund*100).toFixed(3)}%) + call skew. Squeeze likely.`,trades:["Put Spreads","Fade Calls"],meta:[{l:"Funding",v:`${(avgFund*100).toFixed(3)}%`,c:"var(--red)"},{l:"Call Skew",v:`+${avgSkew.toFixed(1)}`,c:"var(--amber)"},{l:"Bias",v:"PUT SPREADS",c:"var(--amber)"}]};
  if(avgIVRank>70&&negGEX>0.55) return{id:"expansion",label:"VOL EXPANSION",color:"var(--red)",glow:"rgba(255,56,96,0.06)",sub:`IV Rank ${avgIVRank.toFixed(0)}%. ${(negGEX*100).toFixed(0)}% neg GEX. Sell vol into peaks.`,trades:["Iron Condors","Short Straddles"],meta:[{l:"Avg IVR",v:`${avgIVRank.toFixed(0)}%`,c:"var(--red)"},{l:"Neg GEX",v:`${(negGEX*100).toFixed(0)}%`,c:"var(--red)"},{l:"Bias",v:"SELL VOL",c:"var(--red)"}]};
  if(btcTrend>10&&avgSkew>0) return{id:"trending",label:"RISK-ON",color:"var(--green)",glow:"rgba(0,220,130,0.06)",sub:`Strong momentum +${btcTrend.toFixed(1)}% 7D. Delta positive.`,trades:["Bull Calls","Long Perps"],meta:[{l:"BTC 7D",v:fPct(btcTrend),c:"var(--green)"},{l:"Skew",v:fPct(avgSkew),c:"var(--green)"},{l:"Bias",v:"LONG DELTA",c:"var(--green)"}]};
  return{id:"neutral",label:"NEUTRAL",color:"var(--cyan)",glow:"rgba(0,229,255,0.04)",sub:`No strong signal. IV fair, funding balanced. Scan for dislocations.`,trades:["Iron Condors","Selective"],meta:[{l:"Avg IVR",v:`${avgIVRank.toFixed(0)}%`,c:"var(--t2)"},{l:"Funding",v:(avgFund*100).toFixed(3)+"%",c:"var(--t2)"},{l:"Bias",v:"SELECTIVE",c:"var(--cyan)"}]};
}

function calcExpectedMove(price,iv,dte){
  const move1s=price*(iv/100)*Math.sqrt(dte/365);
  const move2s=move1s*2;
  const pctMove1s=(iv/100)*Math.sqrt(dte/365)*100;
  return{move1s,move2s,upper1s:price+move1s,lower1s:price-move1s,upper2s:price+move2s,lower2s:price-move2s,pctMove1s};
}

function calcMaxPain(price, sym){
  const seed=sym.charCodeAt(0)*17+(sym.charCodeAt(1)||0)*31;
  const bias=(sr(seed,70)-0.55)*0.08;
  const maxPainPrice=price*(1+bias);
  const round=price>10000?500:price>1000?50:price>100?5:price>10?1:0.01;
  const mp=Math.round(maxPainPrice/round)*round;
  const delta=((mp-price)/price*100);
  return{maxPain:mp,delta,direction:delta>=0?"above":"below"};
}

function calcFairValue(t){
  if(!t)return null;
  const p=t.p;
  const skewBias=t.skew25d*0.003;
  const ivRankBias=(50-t.ivRank)*0.0005;
  const optionsFV=p*(1+skewBias+ivRankBias);
  const momentum7d=(t.ch7d||0)/100;
  const momentum30d=(t.ch30d||0)/100;
  const meanRevFactor=-momentum7d*0.15;
  const trendFactor=momentum30d*0.08;
  const momentumFV=p*(1+meanRevFactor+trendFactor);
  const fundBias=-t.fund*2;
  const lsBias=(1-t.lsRatio)*0.015;
  const posFV=p*(1+fundBias+lsBias);
  const consensus=(optionsFV*0.45+momentumFV*0.30+posFV*0.25);
  const em30=calcExpectedMove(p,t.iv,30);
  const spread=Math.max(optionsFV,momentumFV,posFV)-Math.min(optionsFV,momentumFV,posFV);
  const confidence=Math.max(15,Math.min(90,85-(spread/p*100)*15));
  return{optionsFV,momentumFV,posFV,consensus,confidence,
    range:{low:Math.min(em30.lower1s,consensus*0.95),high:Math.max(em30.upper1s,consensus*1.05)},
    em30,bias:consensus>p?"BULLISH":consensus<p*0.99?"BEARISH":"NEUTRAL"};
}

function calcGammaProfile(sym){
  const t=D.find(d=>d.s===sym);if(!t)return null;
  const price=t.p,iv=t.iv/100,gexBase=t.gammaExp;
  const strikes=[];
  for(let i=0;i<25;i++){
    const pct=-0.18+i*0.36/24;
    const K=price*(1+pct);
    const moneyness=Math.log(K/price);
    const sigma=iv*0.6;
    const gammaAtK=Math.exp(-(moneyness*moneyness)/(2*sigma*sigma));
    const sign=(K<price*1.02)?1:-1;
    const scaled=gammaAtK*sign*Math.abs(gexBase)*0.12;
    strikes.push({K,gex:scaled,moneyness});
  }
  let flipPrice=price;
  for(let i=0;i<strikes.length-1;i++){
    if(strikes[i].gex*strikes[i+1].gex<0){
      const g0=strikes[i].gex,g1=strikes[i+1].gex;
      flipPrice=strikes[i].K+(0-g0)/(g1-g0)*(strikes[i+1].K-strikes[i].K);
      break;
    }
  }
  let wallPrice=price,maxGEX=0;
  strikes.forEach(s=>{if(Math.abs(s.gex)>maxGEX){maxGEX=Math.abs(s.gex);wallPrice=s.K;}});
  const flipDelta=((flipPrice-price)/price*100);
  const regime=gexBase>0?"POSITIVE":"NEGATIVE";
  return{strikes,flipPrice,wallPrice,flipDelta,regime,price,gexBase,maxGEX};
}

function generateSignals(){
  const regime=detectRegime();
  const candidates=[...D].filter(t=>t.mc>500e6).sort((a,b)=>b.conviction-a.conviction);
  const signals=[];
  for(const t of candidates){
    if(signals.length>=9)break;
    let type="neutral",title="",desc="",strategy="",metrics=[];
    const ivRvSpread=t.iv-t.rv30;
    if(t.ivRank<18){type="vol";title="Long Vol Opportunity";desc=`IV Rank at ${t.ivRank}th pctile — vol cheap.`;strategy=`Buy ATM Straddle · ${t.s}`;metrics=[{l:"IVR",v:`${t.ivRank}%`,c:"var(--green)"},{l:"IV",v:`${t.iv}%`,c:"var(--t2)"}];}
    else if(t.ivRank>80){type="sell";title="Sell Vol — IV Rich";desc=`IV Rank ${t.ivRank}% — elevated.`;strategy=`Iron Condor · ${t.s}`;metrics=[{l:"IVR",v:`${t.ivRank}%`,c:"var(--red)"},{l:"IV-RV",v:`+${ivRvSpread.toFixed(1)}%`,c:"var(--red)"}];}
    else if(t.skew25d<-4){type="squeeze";title="Put Skew Extreme";desc=`25Δ skew at ${t.skew25d}.`;strategy=`Risk Reversal · ${t.s}`;metrics=[{l:"Skew",v:`${t.skew25d}`,c:"var(--red)"}];}
    else if(t.skew25d>4){type="squeeze";title="Call Skew Elevated";desc=`Call premium stretched +${t.skew25d}.`;strategy=`Sell OTM Calls · ${t.s}`;metrics=[{l:"Skew",v:`+${t.skew25d}`,c:"var(--amber)"}];}
    else if(Math.abs(t.fund)>0.04){type="squeeze";title=t.fund>0?"Crowded Long":"Crowded Short";desc=`Funding ${(t.fund*100).toFixed(3)}%.`;strategy=t.fund>0?"Put Spreads":"Call Spreads";metrics=[{l:"Fund",v:`${(t.fund*100).toFixed(3)}%`,c:t.fund>0?"var(--red)":"var(--green)"}];}
    else if(t.gammaExp<-t.mc*0.02){type="vol";title="Neg GEX — Amplification";desc=`GEX deeply negative.`;strategy=`Long Straddle · ${t.s}`;metrics=[{l:"GEX",v:fmt(t.gammaExp),c:"var(--red)"}];}
    else continue;
    signals.push({...t,sigType:type,title,desc,strategy,metrics});
  }
  return signals;
}

// ═══ IV Ratio Z-Score (RV Arb) ═════════════════════════════════
const ivRatioHistory={ethBtc:[],solBtc:[],solEth:[]};
function initIVRatioHistory(){
  for(let i=0;i<30;i++){
    const noise=()=>(Math.random()-0.5)*0.15;
    const btcIV=D.find(d=>d.s==="BTC")?.iv||48;
    const ethIV=D.find(d=>d.s==="ETH")?.iv||52;
    const solIV=D.find(d=>d.s==="SOL")?.iv||65;
    ivRatioHistory.ethBtc.push(ethIV/btcIV+noise());
    ivRatioHistory.solBtc.push(solIV/btcIV+noise());
    ivRatioHistory.solEth.push(solIV/ethIV+noise());
  }
}
function calcZScore(arr){
  if(arr.length<5)return{mean:0,std:0,zscore:0,current:0};
  const current=arr[arr.length-1];
  const mean=arr.reduce((s,v)=>s+v,0)/arr.length;
  const variance=arr.reduce((s,v)=>s+(v-mean)**2,0)/arr.length;
  const std=Math.sqrt(variance)||0.001;
  return{mean,std,zscore:(current-mean)/std,current};
}
function updateIVRatios(){
  const btc=D.find(d=>d.s==="BTC"),eth=D.find(d=>d.s==="ETH"),sol=D.find(d=>d.s==="SOL");
  if(!btc||!eth||!sol)return;
  ivRatioHistory.ethBtc.push(eth.iv/btc.iv);
  ivRatioHistory.solBtc.push(sol.iv/btc.iv);
  ivRatioHistory.solEth.push(sol.iv/eth.iv);
  if(ivRatioHistory.ethBtc.length>60)ivRatioHistory.ethBtc.shift();
  if(ivRatioHistory.solBtc.length>60)ivRatioHistory.solBtc.shift();
  if(ivRatioHistory.solEth.length>60)ivRatioHistory.solEth.shift();
}


// ═══ TAB / PANEL BUILDER ═══════════════════════════════════════
function buildTabs(){
  const el=document.getElementById('main-tabs-inner');if(!el)return;
  if(currentMode==='spot'){
    el.innerHTML=`
      <div class="mtab active" onclick="switchTab('dashboard')">Dashboard</div>
      <div class="mtab" onclick="switchTab('funding')">Funding & Liqs</div>
      <div class="mtab" onclick="switchTab('scanner')">Scanner</div>
      <div class="mtab" onclick="switchTab('intel')">Intel</div>
      <div class="mtab" onclick="switchTab('pricing')">Plans</div>`;
  } else {
    el.innerHTML=`
      <div class="mtab active" onclick="switchTab('signals')">Signal Feed</div>
      <div class="mtab" onclick="switchTab('greeks')">Vanna & Charm</div>
      <div class="mtab" onclick="switchTab('simulator')">Dealer Simulator</div>
      <div class="mtab" onclick="switchTab('optionslab')">Options Lab</div>
      <div class="mtab" onclick="switchTab('positioning')">Positioning</div>
      <div class="mtab" onclick="switchTab('fairvalue')">Fair Value</div>
      <div class="mtab" onclick="switchTab('pricing')">Plans</div>`;
  }
}

function buildPanels(){
  const el=document.getElementById('tab-panels');if(!el)return;
  if(currentMode==='spot'){
    el.innerHTML=buildSpotPanels();
  } else {
    el.innerHTML=buildOptionsPanels();
  }
}

function buildSpotPanels(){
  return `
  <!-- SPOT: Dashboard -->
  <div class="tab-panel active" id="panel-dashboard">
    <div class="mkt-strip" id="mkt-strip"></div>
    <div class="mb" style="display:grid;grid-template-columns:1fr 270px 190px;gap:12px">
      <div class="card">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--cyan)"></span>Mindshare Treemap</div>
          <div class="pills">
            <span class="pill act" onclick="setTMMode('mindshare',this)">Mindshare</span>
            <span class="pill" onclick="setTMMode('perf',this)">24H Perf</span>
          </div></div>
        <div class="card-bnp" style="padding:8px"><div class="treemap" id="treemap"></div></div>
      </div>
      <div class="card">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--green)"></span>Top Movers</div></div>
        <div style="display:flex;border-bottom:1px solid var(--border)">
          <div class="mtab active" style="flex:1;text-align:center;font-size:10px;padding:6px" onclick="setGLTab('gain',this)">Gainers</div>
          <div class="mtab" style="flex:1;text-align:center;font-size:10px;padding:6px" onclick="setGLTab('lose',this)">Losers</div>
          <div class="mtab" style="flex:1;text-align:center;font-size:10px;padding:6px" onclick="setGLTab('vol',this)">Vol</div>
        </div>
        <div class="scroll-sm" id="gl-body"></div>
      </div>
      <div class="card">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>Sentiment</div></div>
        <div class="card-b" id="fg-widget" style="display:flex;flex-direction:column;align-items:center;gap:6px"></div>
      </div>
    </div>
    <div class="detail-panel" id="detail-panel" style="position:relative"></div>
    <div class="g2 mb">
      <div class="card">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--violet)"></span>Performance Bubble Map</div>
          <div class="pills" id="bub-pills">
            <span class="pill" onclick="setBubTF('1h',this)">1H</span>
            <span class="pill act" onclick="setBubTF('24h',this)">24H</span>
            <span class="pill" onclick="setBubTF('7d',this)">7D</span>
          </div></div>
        <div class="card-bnp"><div class="bubble-wrap"><canvas id="bub-canvas"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--pink)"></span>News</div><span class="badge b-cyan">LIVE</span></div>
        <div class="card-bnp scroll-md" id="news-dash"></div>
      </div>
    </div>
  </div>

  <!-- SPOT: Funding & Liqs -->
  <div class="tab-panel" id="panel-funding">
    <div style="padding-top:10px">
      <div class="g3 mb">
        <div class="card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--green)"></span>Perp Funding Rates</div><span class="badge b-cyan">LIVE</span></div>
          <div class="card-bnp scroll-sm" id="fund-body"></div>
        </div>
        <div class="card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--red)"></span>24H Liquidations</div></div>
          <div class="card-bnp scroll-sm" id="liq-list"></div>
        </div>
        <div class="card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--green)"></span>Long/Short Ratio</div></div>
          <div class="card-bnp scroll-sm" id="ls-ratio"></div>
        </div>
      </div>
      <div class="g2 mb">
        <div class="card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--cyan)"></span>Open Interest</div></div>
          <div class="card-bnp scroll-sm" id="oi-body"></div>
        </div>
        <div class="card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>BTC Liquidation Heatmap</div></div>
          <div class="card-b"><canvas id="liq-btc" style="width:100%;height:280px"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SPOT: Scanner -->
  <div class="tab-panel" id="panel-scanner">
    <div style="padding-top:10px">
      <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
        <input type="text" id="tbl-search" placeholder="Search..." style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--t1);font-size:11px;font-family:inherit;outline:none;width:200px">
        <div class="pills">
          <span class="pill act" onclick="setTblTF('24h',this)">24H</span>
          <span class="pill" onclick="setTblTF('1h',this)">1H</span>
          <span class="pill" onclick="setTblTF('7d',this)">7D</span>
          <span class="pill" onclick="setTblTF('30d',this)">30D</span>
        </div>
        <div class="cats" id="cat-filters" style="margin-left:8px"></div>
      </div>
      <div class="card"><div class="card-bnp" style="overflow-x:auto;max-height:600px;overflow-y:auto">
        <table class="ftable">
          <thead><tr>
            <th onclick="tSort('sym')">#</th><th onclick="tSort('sym')">Asset</th><th onclick="tSort('price')">Price</th>
            <th onclick="tSort('chg')" id="th-chg">24H %</th><th onclick="tSort('vol')">Volume</th><th onclick="tSort('mc')">MCap</th>
            <th onclick="tSort('fund')">Funding</th><th onclick="tSort('conv')">Conv</th>
          </tr></thead>
          <tbody id="tbl-body"></tbody>
        </table>
      </div></div>
    </div>
  </div>

  <!-- SPOT: Intel -->
  <div class="tab-panel" id="panel-intel">
    <div style="padding-top:10px">
      <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--pink)"></span>Live News</div><span class="badge b-cyan">LIVE</span></div>
        <div class="card-bnp scroll-md" id="news-full"></div></div>
    </div>
  </div>

  <!-- Pricing -->
  <div class="tab-panel" id="panel-pricing">${buildPricingPanel()}</div>`;
}

function buildOptionsPanels(){
  return `
  <!-- OPTIONS: Signal Feed -->
  <div class="tab-panel active" id="panel-signals">
    <div class="ai-search-wrap">
      <span class="ai-icon">K</span>
      <input class="ai-search" id="ai-input" type="text" placeholder="Ask KAITO AI: 'Where is dealer hedging pressure?' · 'Best Vanna trade?'" />
      <div class="ai-kbd"><span class="tag tag-sym">ENTER</span></div>
    </div>
    <div class="ai-response" id="ai-response">
      <div class="thinking" id="ai-thinking">KAITO AI is analyzing…</div>
      <div id="ai-text"></div>
    </div>
    <div class="regime-panel mb" id="regime-panel" style="border-color:var(--border)">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:20px">
        <div>
          <div style="font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Market Regime</div>
          <div class="regime-name" id="regime-name">Detecting…</div>
          <div class="regime-sub" id="regime-sub"></div>
          <div class="regime-meta" id="regime-meta"></div>
        </div>
        <div style="flex-shrink:0;display:flex;flex-direction:column;gap:5px;align-items:flex-end" id="regime-actions"></div>
      </div>
    </div>
    <div class="section-title">Top Conviction Signals</div>
    <div class="signal-grid" id="signal-grid"></div>
    <div class="section-title" style="margin-top:16px">Options-Implied Expected Moves</div>
    <div class="g3 mb">
      <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--btc)"></span>BTC</div><span class="badge b-amber">IV-DERIVED</span></div><div class="card-b"><div class="em-grid" id="em-btc"></div></div></div>
      <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--eth)"></span>ETH</div><span class="badge b-amber">IV-DERIVED</span></div><div class="card-b"><div class="em-grid" id="em-eth"></div></div></div>
      <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--sol)"></span>SOL</div><span class="badge b-amber">IV-DERIVED</span></div><div class="card-b"><div class="em-grid" id="em-sol"></div></div></div>
    </div>
    <!-- Max Pain (de-emphasized, moved to bottom) -->
    <div style="margin-top:20px;opacity:.6">
      <div class="section-title" style="font-size:9px;color:var(--t4)">Max Pain — Reference Only</div>
      <div class="mp-grid" id="max-pain-grid"></div>
    </div>
  </div>

  <!-- OPTIONS: Vanna & Charm -->
  <div class="tab-panel" id="panel-greeks">
    <div style="padding-top:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div class="section-title">Second-Order Dealer Exposure — Vanna & Charm</div>
        <span class="badge b-amber">INSTITUTIONAL</span>
      </div>
      <div class="greek-grid">
        <div class="greek-card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--violet)"></span>Net Vanna — Vol-Sensitivity Hedge</div>
            <span class="badge b-violet">dΔ/dσ</span></div>
          <div style="padding:12px 14px;font-size:10px;color:var(--t3);line-height:1.6;border-bottom:1px solid var(--border)">
            Predicts where dealers must buy/sell the underlying as IV changes. High positive Vanna zones = "Vol-Squeezes" where an IV drop forces dealer spot selling.
          </div>
          <div class="card-bnp scroll-sm" id="vanna-body"></div>
        </div>
        <div class="greek-card">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--teal)"></span>Net Charm — Weekend Decay Hedge</div>
            <span class="badge b-teal">dΔ/dt</span></div>
          <div style="padding:12px 14px;font-size:10px;color:var(--t3);line-height:1.6;border-bottom:1px solid var(--border)">
            Predicts forced dealer flows over weekends/holidays. If dealers are long Charm, they must sell the underlying as time passes — creating structural price drift.
          </div>
          <div class="card-bnp scroll-sm" id="charm-body"></div>
        </div>
      </div>
      <div class="card mb">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>Combined Vanna+Charm Signal</div></div>
        <div class="card-b" id="vanna-charm-signal"></div>
      </div>
    </div>
  </div>

  <!-- OPTIONS: Dealer Hedging Simulator -->
  <div class="tab-panel" id="panel-simulator">
    <div style="padding-top:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div class="section-title">Dealer Hedging Simulator — "What If" Sandbox</div>
        <span class="badge b-amber">PM TOOL</span>
      </div>
      <div class="sim-panel">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>Input Matrix</div></div>
        <div class="sim-controls">
          <div class="sim-control">
            <label>Spot Shift <span class="sim-val" id="sim-spot-val">0%</span></label>
            <input type="range" id="sim-spot" min="-10" max="10" value="0" step="0.5" oninput="updateSim()"/>
            <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--t4)"><span>-10%</span><span>+10%</span></div>
          </div>
          <div class="sim-control">
            <label>Vol Shift <span class="sim-val" id="sim-vol-val">0 pts</span></label>
            <input type="range" id="sim-vol" min="-20" max="20" value="0" step="1" oninput="updateSim()"/>
            <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--t4)"><span>-20</span><span>+20</span></div>
          </div>
          <div class="sim-control">
            <label>Time Step</label>
            <div style="display:flex;gap:4px;margin-top:4px">
              <button class="pill act" id="sim-time-24h" onclick="setSimTime('24h',this)">T + 24h</button>
              <button class="pill" id="sim-time-wk" onclick="setSimTime('weekend',this)">Weekend</button>
            </div>
          </div>
        </div>
        <div class="sim-output" id="sim-output">
          <div class="sim-result" id="sim-result">$0</div>
          <div class="sim-explain" id="sim-explain">Adjust the sliders to see the dealer hedging requirement.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- OPTIONS: Options Lab -->
  <div class="tab-panel" id="panel-optionslab">
    <div style="padding-top:10px">
      <div class="g2 mb">
        <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>IV Rank Heatmap</div></div>
          <div class="card-bnp" style="padding:8px"><div class="iv-grid" id="iv-heatmap-full"></div></div></div>
        <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--teal)"></span>IV vs Realized Vol</div></div>
          <div class="card-bnp" id="ivrv-body-full"></div></div>
      </div>
      <div class="card mb">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--amber)"></span>Options Flow — Live</div><span class="badge b-cyan">LIVE</span></div>
        <div class="card-bnp scroll-md" id="flow-feed-full"></div>
      </div>
      <div class="card mb">
        <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--pink)"></span>25Δ Skew Monitor</div></div>
        <div class="card-bnp" id="skew-body"></div>
      </div>
    </div>
  </div>

  <!-- OPTIONS: Positioning -->
  <div class="tab-panel" id="panel-positioning">
    <div style="padding-top:10px">
      <div class="g2 mb">
        <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--violet)"></span>Gamma Exposure (GEX)</div></div>
          <div class="card-bnp scroll-sm" id="gex-body"></div></div>
        <div class="card"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--orange)"></span>Funding Extremes</div></div>
          <div class="card-bnp scroll-sm" id="fund-body-pos"></div></div>
      </div>
      <div class="section-title">Gamma Flip — Volatility Trigger Zones</div>
      <div class="gflip-grid">
        <div class="gflip-col">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--btc)"></span>BTC Gamma Profile</div><span class="badge b-amber">DEALER GEX</span></div>
          <div style="padding:10px"><canvas id="gflip-canvas-btc" style="width:100%;height:180px"></canvas></div>
          <div class="gflip-meta" id="gflip-meta-btc"></div>
          <div class="gflip-zone" id="gflip-zone-btc"></div>
        </div>
        <div class="gflip-col">
          <div class="card-h"><div class="card-t"><span class="dot" style="background:var(--eth)"></span>ETH Gamma Profile</div><span class="badge b-amber">DEALER GEX</span></div>
          <div style="padding:10px"><canvas id="gflip-canvas-eth" style="width:100%;height:180px"></canvas></div>
          <div class="gflip-meta" id="gflip-meta-eth"></div>
          <div class="gflip-zone" id="gflip-zone-eth"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- OPTIONS: Fair Value -->
  <div class="tab-panel" id="panel-fairvalue">
    <div style="padding-top:10px">
      <div style="display:flex;gap:4px;margin-bottom:14px">
        <span class="pill act" onclick="setFVAsset('BTC',this)">BTC</span>
        <span class="pill" onclick="setFVAsset('ETH',this)">ETH</span>
        <span class="pill" onclick="setFVAsset('SOL',this)">SOL</span>
      </div>
      <div class="fv-panel" id="fv-main-panel"></div>
      <div class="card mb"><div class="card-h"><div class="card-t"><span class="dot" style="background:var(--cyan)"></span>Probability Cone</div></div>
        <div class="card-bnp"><div class="prob-cone-wrap"><canvas id="prob-cone-canvas" style="width:100%;height:280px"></canvas></div></div></div>
    </div>
  </div>

  <!-- Pricing -->
  <div class="tab-panel" id="panel-pricing">${buildPricingPanel()}</div>`;
}

function buildPricingPanel(){
  return `<div style="padding-top:14px">
    <div class="section-title" style="margin-bottom:6px">Strategic Pricing — B2B Risk Infrastructure</div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:16px;line-height:1.6">Stop selling B2C SaaS. Start selling B2B Risk Infrastructure. KAITO delivers institutional-grade dealer exposure analytics.</div>
    <div class="tier-grid">
      <div class="tier-card">
        <div class="tier-name" style="color:var(--cyan)">Pro Trader</div>
        <div class="tier-target">Individual Alpha Seekers</div>
        <div class="tier-price-tag">$199</div>
        <div class="tier-per">/month</div>
        <ul class="tier-features">
          <li>Real-time GEX Levels</li>
          <li>Regime Engine Signals</li>
          <li>IV Rank Scanner</li>
          <li>Options Flow Feed</li>
          <li>Expected Move Calculator</li>
        </ul>
      </div>
      <div class="tier-card tier-highlight">
        <div class="tier-name" style="color:var(--amber)">Institutional Desk</div>
        <div class="tier-target">Hedge Fund PMs / Prop Desks</div>
        <div class="tier-price-tag">$2,500</div>
        <div class="tier-per">/month</div>
        <ul class="tier-features">
          <li>Everything in Pro</li>
          <li>Net Vanna & Charm Analytics</li>
          <li>Dealer Hedging Simulator</li>
          <li>SVI Volatility Surfaces</li>
          <li>Macro Regime Fusion Engine</li>
          <li>Multi-expiry Greek Decomposition</li>
        </ul>
      </div>
      <div class="tier-card">
        <div class="tier-name" style="color:var(--violet)">Enterprise API</div>
        <div class="tier-target">Quant Funds / HFTs</div>
        <div class="tier-price-tag">$10k+</div>
        <div class="tier-per">/month</div>
        <ul class="tier-features">
          <li>Everything in Institutional</li>
          <li>Raw WebSocket Data Pipe</li>
          <li>Net GEX Stream (sub-second)</li>
          <li>ML Probability Signals</li>
          <li>Python SDK: import kaito</li>
          <li>Custom SLA & Integrations</li>
        </ul>
      </div>
    </div>
  </div>`;
}


// ═══ RENDER FUNCTIONS ═══════════════════════════════════════════

function renderMkt(){
  const el=document.getElementById("mkt-strip");if(!el)return;
  const btc=D.find(t=>t.s==="BTC")||{};const eth=D.find(t=>t.s==="ETH")||{};
  const totalMC=D.reduce((s,t)=>s+t.mc,0);const totalVol=D.reduce((s,t)=>s+t.vol,0);
  const avgIVR=D.filter(t=>t.mc>1e9).reduce((s,t)=>s+t.ivRank,0)/Math.max(1,D.filter(t=>t.mc>1e9).length);
  const avgFund=D.filter(t=>t.mc>500e6).reduce((s,t)=>s+t.fund,0)/Math.max(1,D.filter(t=>t.mc>500e6).length);
  const fgVal=LiveData.fgIndex!=null?LiveData.fgIndex:Math.floor(D.reduce((s,t)=>s+t.sent,0)/D.length);
  el.innerHTML=[
    {l:"BTC",v:fPr(btc.p||0),c:`class="${cCls(btc.ch24h||0)}"`,sub:fP(btc.ch24h||0)},
    {l:"ETH",v:fPr(eth.p||0),c:`class="${cCls(eth.ch24h||0)}"`,sub:fP(eth.ch24h||0)},
    {l:"Total MCap",v:fmt(totalMC),c:'style="color:var(--t2)"',sub:""},
    {l:"24H Volume",v:fmt(totalVol),c:'style="color:var(--cyan)"',sub:""},
    {l:"Avg IV Rank",v:`${avgIVR.toFixed(0)}%`,c:`style="color:${avgIVR<30?"var(--green)":avgIVR>70?"var(--red)":"var(--amber)"}"`,sub:""},
    {l:"Avg Funding",v:`${(avgFund*100).toFixed(3)}%`,c:`style="color:${Math.abs(avgFund)>.03?"var(--red)":"var(--green)"}"`,sub:""},
    {l:"Fear & Greed",v:fgVal,c:`style="color:${fgVal<25?"var(--red)":fgVal>75?"var(--green)":"var(--amber)"}"`,sub:fgVal<25?"Extreme Fear":fgVal<45?"Fear":fgVal<55?"Neutral":fgVal<75?"Greed":"Extreme Greed"}
  ].map(s=>`<div class="mkt-c"><div class="l">${s.l}</div><div class="v num-mono" ${s.c}>${s.v}</div>${s.sub?`<div class="c" ${s.c}>${s.sub}</div>`:''}</div>`).join('');
  // Update header
  const hBTC=document.getElementById('h-btcprice');if(hBTC)hBTC.textContent=fPr(btc.p||0);
  const hETH=document.getElementById('h-ethprice');if(hETH)hETH.textContent=fPr(eth.p||0);
  const hIV=document.getElementById('h-btciv');if(hIV)hIV.textContent=`${btc.iv||'—'}%`;
  const hSkew=document.getElementById('h-skew');if(hSkew)hSkew.textContent=btc.skew25d!=null?`${btc.skew25d>=0?'+':''}${btc.skew25d}`:'—';
  const hMC=document.getElementById('h-mc');if(hMC)hMC.textContent=fmt(totalMC);
  const hVol=document.getElementById('h-vol');if(hVol)hVol.textContent=fmt(totalVol);
}

function renderFG(){
  const el=document.getElementById("fg-widget");if(!el)return;
  const fgVal=LiveData.fgIndex!=null?LiveData.fgIndex:Math.floor(D.reduce((s,t)=>s+t.sent,0)/D.length);
  const c=fgVal<25?"var(--red)":fgVal<45?"var(--orange)":fgVal<55?"var(--amber)":fgVal<75?"var(--green)":"var(--cyan)";
  const label=fgVal<25?"EXTREME FEAR":fgVal<45?"FEAR":fgVal<55?"NEUTRAL":fgVal<75?"GREED":"EXTREME GREED";
  el.innerHTML=`<div class="fg-arc-wrap">
    <svg width="120" height="70" viewBox="0 0 120 70">
      <path d="M10,65 A50,50 0 0,1 110,65" fill="none" stroke="var(--surface3)" stroke-width="6" stroke-linecap="round"/>
      <path d="M10,65 A50,50 0 0,1 110,65" fill="none" stroke="${c}" stroke-width="6" stroke-linecap="round"
        stroke-dasharray="${fgVal/100*157}" stroke-dashoffset="0"/>
    </svg>
    <div class="fg-num" style="color:${c};margin-top:-10px">${fgVal}</div>
    <div class="fg-label" style="color:${c}">${label}</div>
  </div>`;
}

function renderTreemap(){
  const el=document.getElementById("treemap");if(!el)return;
  const tokens=[...D].sort((a,b)=>b.mc-a.mc).slice(0,30);
  const totalMS=tokens.reduce((s,t)=>s+t.ms,0);
  el.innerHTML=tokens.map(t=>{
    const pct=t.ms/totalMS*100;
    const chg=t.ch24h;
    const bg=tmMode==="perf"?(chg>=0?`rgba(0,220,130,${Math.min(.6,Math.abs(chg)/20)})`:`rgba(255,56,96,${Math.min(.6,Math.abs(chg)/20)})`)
             :tmMode==="ivrank"?(t.ivRank<30?`rgba(0,220,130,${.15+t.ivRank/200})`:t.ivRank>70?`rgba(255,56,96,${.15+t.ivRank/300})`:`rgba(100,100,128,${.1+t.ivRank/400})`)
             :`hsla(${(t.seed*47)%360},50%,25%,0.7)`;
    const w=Math.max(60,pct*12);const h=Math.max(48,pct*3+30);
    return`<div class="tm" style="width:${w}px;height:${h}px;background:${bg}" onclick="selectAsset('${t.s}')">
      <div class="s" style="font-size:${pct>5?12:10}px">${t.s}</div>
      <div class="p ${cCls(chg)}">${fP(chg)}</div>
    </div>`;
  }).join('');
}

function renderGL(){
  const el=document.getElementById("gl-body");if(!el)return;
  let tokens=[...D].filter(t=>t.mc>100e6);
  if(glTab==="gain")tokens.sort((a,b)=>b.ch24h-a.ch24h);
  else if(glTab==="lose")tokens.sort((a,b)=>a.ch24h-b.ch24h);
  else tokens.sort((a,b)=>b.vol-a.vol);
  el.innerHTML=tokens.slice(0,10).map((t,i)=>`
    <div class="gl-row" onclick="selectAsset('${t.s}')">
      <div class="gl-left"><div class="gl-rank">${i+1}</div><div><div class="gl-sym">${t.s}</div><div class="gl-name">${t.n.slice(0,12)}</div></div></div>
      <div class="gl-right"><div class="gl-chg ${cCls(t.ch24h)}">${fP(t.ch24h)}</div><div class="gl-price">${fPr(t.p)}</div></div>
    </div>`).join('');
}

function renderBubbles(){
  const canvas=document.getElementById("bub-canvas");if(!canvas)return;
  const ctx=canvas.getContext("2d");const dpr=window.devicePixelRatio||1;
  const W=canvas.parentElement.offsetWidth||600,H=360;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const chgKey=bubTF==="1h"?"ch1h":bubTF==="7d"?"ch7d":"ch24h";
  const tokens=[...D].filter(t=>t.mc>100e6).slice(0,40);
  const maxMC=Math.max(...tokens.map(t=>t.mc));
  tokens.forEach(t=>{
    const chg=t[chgKey]||0;
    const r=Math.sqrt(t.mc/maxMC)*45+6;
    const x=((sr(t.seed,40))*0.85+0.075)*W;
    const y=((sr(t.seed,41))*0.8+0.1)*H;
    const color=chg>=0?`rgba(0,220,130,${Math.min(.7,.15+Math.abs(chg)/30)})`:`rgba(255,56,96,${Math.min(.7,.15+Math.abs(chg)/30)})`;
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    ctx.fillStyle="#fff";ctx.font=`bold ${r>15?10:8}px 'DM Sans'`;ctx.textAlign="center";
    ctx.fillText(t.s,x,y-2);ctx.font=`${r>15?9:7}px 'Space Mono'`;ctx.fillStyle="rgba(255,255,255,.6)";
    ctx.fillText(fP(chg),x,y+10);
  });
}

function renderNews(id){
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML=NEWS.map(n=>`
    <div class="news-item">
      <div class="news-time">${n.time} ago</div>
      <div class="news-title">${n.t}</div>
      <div class="news-tags">${n.tags.map(g=>`<span class="tag ${tagCls[g]||"tag-sym"}">${g}</span>`).join('')}</div>
    </div>`).join('');
}

function renderFunding(id="fund-body"){
  const el=document.getElementById(id);if(!el)return;
  const tokens=[...D].filter(t=>t.mc>500e6).sort((a,b)=>Math.abs(b.fund)-Math.abs(a.fund)).slice(0,16);
  el.innerHTML=tokens.map(t=>{
    const isPos=t.fund>=0;const pct=Math.abs(t.fund)/.065;
    const c=Math.abs(t.fund)>0.03?"var(--red)":Math.abs(t.fund)>0.01?"var(--amber)":"var(--green)";
    return`<div class="fb"><div class="fb-s">${t.s}</div><div class="fb-bar"><div class="fb-fill" style="width:${Math.min(100,pct*100).toFixed(0)}%;background:${c};${isPos?"left:0":"right:0"}"></div></div><div class="fb-v num-mono" style="color:${c}">${isPos?"+":""}${(t.fund*100).toFixed(3)}%</div></div>`;
  }).join('');
}

function renderLiqData(){
  const tokens=[...D].filter(t=>t.mc>100e6).sort((a,b)=>b.liq-a.liq).slice(0,16);
  const el=document.getElementById("liq-list");if(el)el.innerHTML=tokens.map(t=>{
    const lp=sr(t.seed,30);
    return`<div class="fb"><div class="fb-s">${t.s}</div><div style="flex:1;display:flex;gap:2px;align-items:center;margin:0 8px"><div style="flex:${lp*100};height:4px;background:var(--green);border-radius:2px 0 0 2px;opacity:.6"></div><div style="flex:${(1-lp)*100};height:4px;background:var(--red);border-radius:0 2px 2px 0;opacity:.6"></div></div><div class="fb-v num-mono" style="color:var(--t2)">${fmt(t.liq)}</div></div>`;
  }).join('');
  const el2=document.getElementById("ls-ratio");if(el2)el2.innerHTML=[...D].filter(t=>t.mc>500e6).sort((a,b)=>b.mc-a.mc).slice(0,14).map(t=>{
    const lp=(t.lsRatio/(t.lsRatio+1))*100;
    return`<div class="fb"><div class="fb-s">${t.s}</div><div style="flex:1;display:flex;gap:1px;align-items:center;margin:0 8px"><div style="flex:${lp};height:4px;background:var(--green);border-radius:2px 0 0 2px"></div><div style="flex:${100-lp};height:4px;background:var(--red);border-radius:0 2px 2px 0"></div></div><div class="fb-v num-mono">${t.lsRatio}</div></div>`;
  }).join('');
  const el3=document.getElementById("oi-body");if(el3)el3.innerHTML=[...D].filter(t=>t.mc>300e6).sort((a,b)=>b.oi-a.oi).slice(0,14).map(t=>`
    <div class="fb"><div class="fb-s">${t.s}</div><div style="flex:1;margin:0 8px"><div style="height:4px;background:var(--surface3);border-radius:2px;overflow:hidden"><div style="height:100%;width:${Math.min(100,t.oi/D[0].oi*100)}%;background:var(--cyan);border-radius:2px"></div></div></div><div class="fb-v num-mono" style="color:var(--cyan)">${fmt(t.oi)}</div></div>`).join('');
}

function renderIVHeatmap(id){
  const el=document.getElementById(id);if(!el)return;
  const sorted=[...D].filter(t=>t.mc>100e6).sort((a,b)=>b.mc-a.mc).slice(0,id.includes("full")?60:36);
  el.innerHTML=sorted.map(t=>{
    const c=t.ivRank<25?{bg:"rgba(0,220,130,.1)",tc:"var(--green)",bc:"rgba(0,220,130,.2)"}:t.ivRank>75?{bg:"rgba(255,56,96,.1)",tc:"var(--red)",bc:"rgba(255,56,96,.2)"}:{bg:"var(--surface2)",tc:"var(--t3)",bc:"var(--border)"};
    return`<div class="iv-cell" style="background:${c.bg};border-color:${c.bc}" onclick="selectAsset('${t.s}')"><div class="sym">${t.s}</div><div class="ivr num-mono" style="color:${c.tc}">${t.ivRank}%</div><div class="ivv">${t.iv.toFixed(0)}v</div></div>`;
  }).join('');
}

function renderRegime(){
  const r=detectRegime();
  const pill=document.getElementById("regime-pill");
  if(pill){pill.style.borderColor=r.color;pill.style.background=r.glow;document.getElementById("regime-pill-text").textContent=r.label;document.getElementById("regime-pill-text").style.color=r.color;}
  const panel=document.getElementById("regime-panel");
  if(panel){
    panel.style.borderColor=r.color;
    const rn=document.getElementById("regime-name");if(rn){rn.textContent=r.label;rn.style.color=r.color;}
    const rs=document.getElementById("regime-sub");if(rs)rs.textContent=r.sub;
    const rm=document.getElementById("regime-meta");if(rm)rm.innerHTML=r.meta.map(m=>`<div class="regime-m-item"><span class="l">${m.l}</span><span class="v num-mono" style="color:${m.c}">${m.v}</span></div>`).join('');
    const ra=document.getElementById("regime-actions");if(ra)ra.innerHTML=r.trades.map(tr=>`<span class="regime-action-tag" style="background:${r.glow};border-color:${r.color};color:${r.color}">${tr}</span>`).join('');
  }
}

function renderSignals(){
  const sigs=generateSignals();
  const colMap={vol:"sig-vol",sell:"sig-sell",squeeze:"sig-neutral",skew:"sig-vol",neutral:"sig-neutral"};
  const convCol=c=>c>=80?"var(--green)":c>=60?"var(--amber)":"var(--cyan)";
  const el=document.getElementById("signal-grid");if(!el)return;
  el.innerHTML=sigs.slice(0,6).map(s=>`
    <div class="sig-card ${colMap[s.sigType]||"sig-neutral"}" onclick="selectAsset('${s.s}')">
      <div class="sig-header"><div><span class="sig-asset">${s.s}</span><span style="font-size:9px;color:var(--t4);margin-left:6px">${s.cat}</span></div><span class="sig-conv" style="color:${convCol(s.conviction)}">C:${s.conviction}</span></div>
      <div class="sig-title">${s.title}</div>
      <div class="sig-desc">${s.desc}</div>
      <div class="sig-metrics">${s.metrics.map(m=>`<div class="sig-m"><div class="l">${m.l}</div><div class="v num-mono" style="color:${m.c}">${m.v}</div></div>`).join('')}</div>
      <div class="sig-strategy">${s.strategy}</div>
    </div>`).join('');
}

function renderExpectedMove(id,sym){
  const el=document.getElementById(id);if(!el)return;
  const t=D.find(d=>d.s===sym);if(!t)return;
  const tenors=[{label:"7D",dte:7,cls:"em-7d"},{label:"14D",dte:14,cls:"em-14d"},{label:"30D",dte:30,cls:"em-30d"},{label:"90D",dte:90,cls:"em-90d"}];
  el.innerHTML=tenors.map(tn=>{
    const em=calcExpectedMove(t.p,t.iv,tn.dte);
    return`<div class="em-card ${tn.cls}"><div class="em-tenor">${tn.label}</div><div class="em-range num-mono">±${fPr(em.move1s)}</div><div class="em-pct num-mono">±${em.pctMove1s.toFixed(1)}%</div>
      <div class="em-bar"><div class="em-bar-fill em-2s" style="left:5%;width:90%"></div></div>
      <div class="em-bar" style="margin-top:2px"><div class="em-bar-fill em-1s" style="left:15%;width:70%"></div></div>
      <div class="em-labels"><span>${fPr(em.lower1s)}</span><span>${fPr(em.upper1s)}</span></div></div>`;
  }).join('');
}

function renderMaxPain(){
  const el=document.getElementById("max-pain-grid");if(!el)return;
  el.innerHTML=["BTC","ETH","SOL"].map(sym=>{
    const t=D.find(d=>d.s===sym);if(!t)return'';
    const mp=calcMaxPain(t.p,sym);
    return`<div class="mp-card"><div class="mp-sym">${sym}</div><div class="mp-price num-mono">${fPr(mp.maxPain)}</div><div class="mp-delta">${mp.delta>=0?"+":""}${mp.delta.toFixed(1)}% from spot</div></div>`;
  }).join('');
}

function renderFlowFeed(id,filter){
  let flows=FLOWS;
  if(filter==="sweep")flows=flows.filter(f=>f.isSweep);
  else if(filter==="block")flows=flows.filter(f=>f.ot==="BLOCK");
  else if(filter==="call")flows=flows.filter(f=>f.type==="CALL");
  else if(filter==="put")flows=flows.filter(f=>f.type==="PUT");
  else if(filter==="spread")flows=flows.filter(f=>f.spreadType);
  else if(["btc","eth","sol"].includes(filter))flows=flows.filter(f=>f.asset===filter.toUpperCase());
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML=flows.slice(0,30).map(f=>{
    const typeColor=f.type==="CALL"?"var(--green)":"var(--red)";
    const typeBg=f.type==="CALL"?"var(--green2)":"var(--red2)";
    const ageStr=f.age<60?`${f.age}s ago`:f.age<3600?`${Math.floor(f.age/60)}m ago`:`${Math.floor(f.age/3600)}h ago`;
    return`<div class="flow-item"><div class="flow-type" style="background:${typeBg};color:${typeColor}">${f.type}</div>
      <div class="flow-main"><div class="flow-trade">${f.asset} ${f.expiry} $${f.strike.toFixed(0)} ${f.type}${f.isSweep?` <span class="flow-sweep">${f.ot}</span>`:''}${f.isLarge?` <span class="flow-sweep" style="background:var(--violet2);color:var(--violet)">LARGE</span>`:''}</div>
        <div class="flow-detail num-mono">${f.contracts} cntrcts · ${f.venue}${f.isLive?' <span style="color:var(--green);font-size:7px">● LIVE</span>':''}${f.iv?' · IV '+f.iv+'%':''}</div></div>
      <div class="flow-right"><div class="flow-premium num-mono" style="color:${f.premium>100000?"var(--amber)":"var(--t2)"}">${fmt(f.premium)}</div><div class="flow-time num-mono">${ageStr}</div></div></div>`;
  }).join('');
}

function renderIVRV(id){
  const el=document.getElementById(id);if(!el)return;
  const tokens=[...D].filter(t=>t.mc>1e9).sort((a,b)=>Math.abs(b.ivRv)-Math.abs(a.ivRv)).slice(0,12);
  el.innerHTML=tokens.map(t=>{
    const spread=t.ivRv;
    const sig=spread<-5?{label:"BUY VOL",cls:"b-green"}:spread>5?{label:"SELL VOL",cls:"b-red"}:{label:"FAIR",cls:"b-neutral"};
    return`<div class="ivrvrow"><div class="ivrv-sym">${t.s}</div><div class="ivrv-vals"><div class="ivrv-val"><div class="l">IV</div><div class="v num-mono" style="color:var(--amber)">${t.iv}%</div></div><div class="ivrv-val"><div class="l">RV30</div><div class="v num-mono">${t.rv30}%</div></div></div><div class="ivrv-spread num-mono" style="color:${spread<0?"var(--green)":spread>0?"var(--red)":"var(--t3)"}">${spread>=0?"+":""}${spread.toFixed(1)}%</div><div class="ivrv-signal"><span class="badge ${sig.cls}">${sig.label}</span></div></div>`;
  }).join('');
}

function renderSkewMonitor(){
  const el=document.getElementById("skew-body");if(!el)return;
  const tokens=[...D].filter(t=>t.mc>1e9).sort((a,b)=>b.mc-a.mc).slice(0,12);
  el.innerHTML=tokens.map(t=>{
    const color=t.skew25d<-3?"var(--red)":t.skew25d>3?"var(--green)":"var(--t3)";
    const fillLeft=t.skew25d<0?`left:${Math.max(0,50+t.skew25d/12*45).toFixed(1)}%;width:${Math.abs(t.skew25d/12*45).toFixed(1)}%;background:var(--red);`:`left:50%;width:${(t.skew25d/12*45).toFixed(1)}%;background:var(--green);`;
    return`<div class="skew-row"><div class="skew-sym">${t.s}</div><div class="skew-bar-wrap"><div class="skew-bar-center"></div><div class="skew-bar-fill" style="${fillLeft}border-radius:3px"></div></div><div class="skew-val num-mono" style="color:${color}">${t.skew25d>=0?"+":""}${t.skew25d}</div></div>`;
  }).join('');
}

function renderGEX(){
  const el=document.getElementById("gex-body");if(!el)return;
  const tokens=[...D].filter(t=>t.mc>500e6).sort((a,b)=>Math.abs(b.gammaExp)-Math.abs(a.gammaExp)).slice(0,14);
  const maxAbs=Math.max(...tokens.map(t=>Math.abs(t.gammaExp)));
  el.innerHTML=tokens.map(t=>{
    const isNeg=t.gammaExp<0;const pct=Math.abs(t.gammaExp)/maxAbs*100;
    return`<div class="gex-row"><div class="gex-sym">${t.s}</div><div class="gex-bar-wrap"><div class="gex-bar" style="width:${pct.toFixed(0)}%;background:${isNeg?"var(--red)":"var(--green)"}"></div></div><div class="gex-val num-mono" style="color:${isNeg?"var(--red)":"var(--green)"}">${isNeg?"-":"+"}${fmt(Math.abs(t.gammaExp))}</div><div class="gex-type" style="color:${isNeg?"var(--red)":"var(--green)"}">${isNeg?"Amplifies":"Dampens"}</div></div>`;
  }).join('');
}

// ═══ VANNA & CHARM RENDERERS ═══════════════════════════════════
function renderVanna(){
  const el=document.getElementById("vanna-body");if(!el)return;
  const assets=['BTC','ETH','SOL','BNB','AVAX','LINK','DOGE','AAVE','UNI','INJ'];
  const tokens=assets.map(s=>D.find(d=>d.s===s)).filter(Boolean).sort((a,b)=>Math.abs(b.netVanna)-Math.abs(a.netVanna));
  const maxAbs=Math.max(...tokens.map(t=>Math.abs(t.netVanna)),1);
  el.innerHTML=tokens.map(t=>{
    const isPos=t.netVanna>=0;
    const pct=Math.abs(t.netVanna)/maxAbs*100;
    const signal=isPos?{label:"VOL-SQUEEZE",cls:"b-red",desc:"IV drop → dealers sell spot"}:{label:"VOL-BID",cls:"b-green",desc:"IV spike → dealers buy spot"};
    return`<div class="greek-row"><div class="greek-sym">${t.s}</div><div class="greek-bar-wrap"><div class="greek-bar" style="width:${pct.toFixed(0)}%;background:${isPos?"var(--red)":"var(--green)"}"></div></div><div class="greek-val num-mono" style="color:${isPos?"var(--red)":"var(--green)"}">${fmt(Math.abs(t.netVanna))}</div><div class="greek-signal"><span class="badge ${signal.cls}" style="font-size:7px">${signal.label}</span></div></div>`;
  }).join('');
}

function renderCharm(){
  const el=document.getElementById("charm-body");if(!el)return;
  const assets=['BTC','ETH','SOL','BNB','AVAX','LINK','DOGE','AAVE','UNI','INJ'];
  const tokens=assets.map(s=>D.find(d=>d.s===s)).filter(Boolean).sort((a,b)=>Math.abs(b.netCharm)-Math.abs(a.netCharm));
  const maxAbs=Math.max(...tokens.map(t=>Math.abs(t.netCharm)),1);
  el.innerHTML=tokens.map(t=>{
    const isPos=t.netCharm>=0;
    const pct=Math.abs(t.netCharm)/maxAbs*100;
    const signal=isPos?{label:"SELL DRIFT",cls:"b-red",desc:"Dealers sell as time passes"}:{label:"BUY DRIFT",cls:"b-green",desc:"Dealers buy as time passes"};
    return`<div class="greek-row"><div class="greek-sym">${t.s}</div><div class="greek-bar-wrap"><div class="greek-bar" style="width:${pct.toFixed(0)}%;background:${isPos?"var(--red)":"var(--green)"}"></div></div><div class="greek-val num-mono" style="color:${isPos?"var(--red)":"var(--green)"}">${fmt(Math.abs(t.netCharm))}</div><div class="greek-signal"><span class="badge ${signal.cls}" style="font-size:7px">${signal.label}</span></div></div>`;
  }).join('');
}

function renderVannaCharmSignal(){
  const el=document.getElementById("vanna-charm-signal");if(!el)return;
  const btc=D.find(d=>d.s==='BTC')||{};const eth=D.find(d=>d.s==='ETH')||{};
  const btcVannaDir=btc.netVanna>0?"sell":"buy";
  const btcCharmDir=btc.netCharm>0?"sell":"buy";
  const combined=btcVannaDir===btcCharmDir;
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div style="background:var(--bg2);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--t4);text-transform:uppercase;margin-bottom:4px">BTC Net Vanna Signal</div>
        <div style="font-size:16px;font-weight:800;font-family:'Space Mono',monospace;color:${btcVannaDir==='sell'?'var(--red)':'var(--green)'}">${btcVannaDir.toUpperCase()} PRESSURE</div>
        <div style="font-size:9px;color:var(--t3);margin-top:2px">${btcVannaDir==='sell'?'If IV drops, dealers forced to sell spot':'If IV spikes, dealers forced to buy spot'}</div>
      </div>
      <div style="background:var(--bg2);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--t4);text-transform:uppercase;margin-bottom:4px">BTC Net Charm Signal</div>
        <div style="font-size:16px;font-weight:800;font-family:'Space Mono',monospace;color:${btcCharmDir==='sell'?'var(--red)':'var(--green)'}">${btcCharmDir.toUpperCase()} DRIFT</div>
        <div style="font-size:9px;color:var(--t3);margin-top:2px">${btcCharmDir==='sell'?'Weekend/holiday decay → forced spot selling':'Weekend/holiday decay → forced spot buying'}</div>
      </div>
    </div>
    <div style="background:${combined?'rgba(255,56,96,.04)':'rgba(245,158,11,.04)'};border:1px solid ${combined?'rgba(255,56,96,.15)':'rgba(245,158,11,.15)'};border-radius:8px;padding:12px;font-size:11px;color:var(--t2);line-height:1.6">
      ${combined?`<strong style="color:var(--${btcVannaDir==='sell'?'red':'green'})">${btcVannaDir==='sell'?'CONVERGENT SELL':'CONVERGENT BUY'} SIGNAL:</strong> Both Vanna and Charm point to dealer ${btcVannaDir} pressure on BTC. This creates a structural ${btcVannaDir==='sell'?'headwind':'tailwind'} — particularly strong over weekends when Charm effects compound.`
              :`<strong style="color:var(--amber)">MIXED SIGNAL:</strong> Vanna (${btcVannaDir}) and Charm (${btcCharmDir}) are divergent. Net dealer hedging effect is partially offset. Watch for vol regime shift to break the tie.`}
    </div>`;
}

function renderOppScanner(){
  const el=document.getElementById("opp-scanner");if(!el)return;
  const top=[...D].filter(t=>t.mc>300e6).sort((a,b)=>b.conviction-a.conviction).slice(0,12);
  const maxConv=top[0]?.conviction||100;
  const convColor=c=>c>=80?"var(--green)":c>=60?"var(--amber)":"var(--cyan)";
  el.innerHTML=top.map((t,i)=>`
    <div class="scan-row" onclick="selectAsset('${t.s}')"><div class="scan-rank">${i+1}</div><div class="scan-sym">${t.s}</div>
      <div class="scan-bar"><div class="scan-bar-fill" style="width:${(t.conviction/maxConv*100).toFixed(0)}%;background:${convColor(t.conviction)}"></div></div>
      <div class="scan-meta"><span style="color:var(--amber)">IV ${t.ivRank}%</span></div>
      <div class="scan-score" style="color:${convColor(t.conviction)}">${t.conviction}</div></div>`).join('');
}

function renderTable(){
  const el=document.getElementById("tbl-body");if(!el)return;
  const q=(document.getElementById("tbl-search")?.value||"").toLowerCase();
  const th=document.getElementById("th-chg");if(th)th.textContent=tblTF.toUpperCase()+" %";
  let rows=[...D];
  if(catFilter!=="All")rows=rows.filter(t=>t.cat===catFilter);
  if(q)rows=rows.filter(t=>t.s.toLowerCase().includes(q)||t.n.toLowerCase().includes(q));
  const chgKey=tblTF==="1h"?"ch1h":tblTF==="7d"?"ch7d":tblTF==="30d"?"ch30d":"ch24h";
  const sortFns={sym:(a,b)=>a.s.localeCompare(b.s),price:(a,b)=>b.p-a.p,chg:(a,b)=>b[chgKey]-a[chgKey],vol:(a,b)=>b.vol-a.vol,mc:(a,b)=>b.mc-a.mc,fund:(a,b)=>b.fund-a.fund,conv:(a,b)=>b.conviction-a.conviction};
  rows.sort(sortFns[tSortK]||(()=>0));
  if(tSortD==="asc")rows.reverse();
  el.innerHTML=rows.slice(0,60).map((t,i)=>{
    const chg=t[chgKey];
    return`<tr>
      <td style="color:var(--t4);font-size:9px">${i+1}</td>
      <td><div style="font-weight:700;font-size:11px">${t.s} <span style="font-size:9px;color:var(--t4)">${t.n.slice(0,12)}</span></div></td>
      <td class="num-mono">${fPr(t.p)}</td>
      <td class="num-mono ${cCls(chg)}" style="font-weight:700">${fP(chg)}</td>
      <td class="num-mono" style="color:var(--t3);font-size:10px">${fmt(t.vol)}</td>
      <td class="num-mono" style="color:var(--t3);font-size:10px">${fmt(t.mc)}</td>
      <td class="num-mono" style="color:${Math.abs(t.fund)>.03?"var(--red)":"var(--green)"};font-size:10px">${t.fund>=0?"+":""}${(t.fund*100).toFixed(3)}%</td>
      <td class="num-mono" style="font-weight:700;color:${t.conviction>=80?"var(--green)":t.conviction>=55?"var(--amber)":"var(--cyan)"}">${t.conviction}</td>
    </tr>`;
  }).join('');
}

function renderCats(){
  const el=document.getElementById("cat-filters");if(!el)return;
  const cats=["All",...new Set(D.map(t=>t.cat))];
  el.innerHTML=cats.slice(0,10).map(c=>`<button class="cat-b ${c===catFilter?"act":""}" onclick="setCat('${c}',this)">${c}</button>`).join('');
}

function renderTicker(){
  const top=[...D].sort((a,b)=>b.mc-a.mc).slice(0,20);
  const items=top.map(t=>`<span class="ti"><span class="s">${t.s}</span> ${fPr(t.p)} <span class="${cCls(t.ch24h)}">${fP(t.ch24h)}</span></span>`).join('');
  const el=document.getElementById("ticker");if(el)el.innerHTML=items+items;
}

function renderFVPanel(){
  const el=document.getElementById("fv-main-panel");if(!el)return;
  const t=D.find(d=>d.s===fvAsset);if(!t)return;
  const fv=calcFairValue(t);if(!fv)return;
  const deltaC=((fv.consensus-t.p)/t.p*100);
  const dc=v=>v>=0?"var(--green)":"var(--red)";
  el.innerHTML=`<div class="fv-header"><div><div style="font-size:18px;font-weight:900">${fvAsset}</div></div><div style="text-align:right"><div style="font-size:11px;color:var(--t4)">Spot</div><div style="font-size:22px;font-weight:900;font-family:'Space Mono',monospace">${fPr(t.p)}</div></div></div>
    <div class="fv-consensus"><div style="font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Consensus Fair Value (30D)</div>
      <div class="big-price" style="color:${dc(deltaC)}">${fPr(fv.consensus)}</div>
      <div style="font-size:11px;color:${dc(deltaC)};font-weight:600;margin-top:2px">${deltaC>=0?"+":""}${deltaC.toFixed(2)}% from spot</div>
      <div style="margin-top:8px;font-size:10px;color:var(--t3)">Confidence: ${fv.confidence.toFixed(0)}% · Bias: <span style="color:${fv.bias==='BULLISH'?'var(--green)':fv.bias==='BEARISH'?'var(--red)':'var(--t2)'}">${fv.bias}</span></div>
    </div>`;
}

function renderProbCone(){
  const canvas=document.getElementById("prob-cone-canvas");if(!canvas)return;
  const ctx=canvas.getContext("2d");const dpr=window.devicePixelRatio||1;
  const rect=canvas.getBoundingClientRect();const W=rect.width||600,H=280;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const t=D.find(d=>d.s===fvAsset);if(!t)return;
  const iv=t.iv/100,p=t.p;
  const days=[0,7,14,30,60,90,120,180];
  const ranges=days.map(d=>{const vol=iv*Math.sqrt(d/365);return{d,upper2s:p*Math.exp(2*vol),upper1s:p*Math.exp(vol),center:p,lower1s:p*Math.exp(-vol),lower2s:p*Math.exp(-2*vol)};});
  const allVals=[...ranges.map(r=>r.upper2s),...ranges.map(r=>r.lower2s)];
  const minP=Math.min(...allVals)*.98,maxP=Math.max(...allVals)*1.01;
  const toX=i=>(i/(days.length-1))*(W-60)+35;
  const toY=v=>H-25-(v-minP)/(maxP-minP)*(H-40);
  ctx.strokeStyle="rgba(255,255,255,.03)";ctx.lineWidth=1;
  for(let i=0;i<days.length;i++){const x=toX(i);ctx.beginPath();ctx.moveTo(x,5);ctx.lineTo(x,H-20);ctx.stroke();}
  // 2σ cone
  ctx.beginPath();ranges.forEach((r,i)=>{const x=toX(i),y=toY(r.upper2s);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  for(let i=ranges.length-1;i>=0;i--){ctx.lineTo(toX(i),toY(ranges[i].lower2s));}ctx.closePath();ctx.fillStyle="rgba(168,85,247,.06)";ctx.fill();
  // 1σ cone
  ctx.beginPath();ranges.forEach((r,i)=>{const x=toX(i),y=toY(r.upper1s);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  for(let i=ranges.length-1;i>=0;i--){ctx.lineTo(toX(i),toY(ranges[i].lower1s));}ctx.closePath();ctx.fillStyle="rgba(0,229,255,.08)";ctx.fill();
  // Center line
  ctx.beginPath();ctx.strokeStyle="rgba(255,255,255,.3)";ctx.lineWidth=1.5;ctx.setLineDash([3,3]);
  ranges.forEach((r,i)=>{i===0?ctx.moveTo(toX(i),toY(r.center)):ctx.lineTo(toX(i),toY(r.center))});ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(toX(0),toY(p),4,0,Math.PI*2);ctx.fill();
}

function drawGammaProfile(canvasId,sym,metaId,zoneId){
  const canvas=document.getElementById(canvasId);if(!canvas)return;
  const profile=calcGammaProfile(sym);if(!profile)return;
  const ctx=canvas.getContext("2d");const dpr=window.devicePixelRatio||1;
  const W=canvas.parentElement.offsetWidth-20||400,H=180;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const {strikes,flipPrice,wallPrice,price,maxGEX}=profile;
  const minK=strikes[0].K,maxK=strikes[strikes.length-1].K;
  const absMax=Math.max(...strikes.map(s=>Math.abs(s.gex)));
  const toX=k=>(k-minK)/(maxK-minK)*(W-40)+20;
  const toY=g=>H/2-(g/absMax)*(H/2-20);
  ctx.strokeStyle="rgba(255,255,255,.08)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(20,H/2);ctx.lineTo(W-20,H/2);ctx.stroke();
  // Fill areas
  ctx.beginPath();ctx.moveTo(toX(strikes[0].K),H/2);
  strikes.forEach(s=>{ctx.lineTo(toX(s.K),Math.min(toY(s.gex),H/2))});
  ctx.lineTo(toX(strikes[strikes.length-1].K),H/2);ctx.closePath();ctx.fillStyle="rgba(0,220,130,.12)";ctx.fill();
  ctx.beginPath();ctx.moveTo(toX(strikes[0].K),H/2);
  strikes.forEach(s=>{ctx.lineTo(toX(s.K),Math.max(toY(s.gex),H/2))});
  ctx.lineTo(toX(strikes[strikes.length-1].K),H/2);ctx.closePath();ctx.fillStyle="rgba(255,56,96,.12)";ctx.fill();
  // GEX curve
  ctx.beginPath();ctx.strokeStyle="rgba(0,229,255,.6)";ctx.lineWidth=2;
  strikes.forEach((s,i)=>{i===0?ctx.moveTo(toX(s.K),toY(s.gex)):ctx.lineTo(toX(s.K),toY(s.gex))});ctx.stroke();
  // Flip line
  const flipX=toX(flipPrice);ctx.strokeStyle="rgba(255,183,0,.7)";ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
  ctx.beginPath();ctx.moveTo(flipX,10);ctx.lineTo(flipX,H-10);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle="rgba(255,183,0,.9)";ctx.font="bold 8px 'DM Sans'";ctx.textAlign="center";ctx.fillText("FLIP",flipX,12);
  // Spot
  ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(toX(price),toY(0),3,0,Math.PI*2);ctx.fill();
  // Meta
  const metaEl=document.getElementById(metaId);
  if(metaEl)metaEl.innerHTML=[{l:"Flip Price",v:fPr(profile.flipPrice),c:"var(--amber)"},{l:"Δ From Spot",v:`${profile.flipDelta>=0?"+":""}${profile.flipDelta.toFixed(2)}%`,c:profile.flipDelta>=0?"var(--green)":"var(--red)"},{l:"Regime",v:profile.regime,c:profile.regime==="POSITIVE"?"var(--green)":"var(--red)"}].map(s=>`<div class="gflip-stat"><div class="l">${s.l}</div><div class="v num-mono" style="color:${s.c}">${s.v}</div></div>`).join('');
  const zoneEl=document.getElementById(zoneId);
  if(zoneEl)zoneEl.innerHTML=`${sym} gamma flip at ${fPr(profile.flipPrice)} (${profile.flipDelta>=0?"+":""}${profile.flipDelta.toFixed(1)}% from spot). Regime: <strong style="color:${profile.regime==="POSITIVE"?"var(--green)":"var(--red)"}">${profile.regime} GEX</strong>`;
}

function drawLiqHeatmap(id,price,low,high){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext("2d");const dpr=window.devicePixelRatio||1;
  const W=canvas.parentElement.offsetWidth||500,H=280;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const cols=55,rows=22,range=high-low,cw=W/cols,rh=H/rows;
  for(let x=0;x<cols;x++)for(let y=0;y<rows;y++){
    const priceLevel=high-(y/rows)*range;
    const a=Math.exp(-((priceLevel-(price*1.03))**2)/(range*.05)**2);
    const b=Math.exp(-((priceLevel-(price*.96))**2)/(range*.04)**2);
    let intensity=Math.max(0,Math.min(1,(Math.sin(x*.3+y*.2)*.25+a+b)*.75+Math.random()*.1));
    let r,g,b2;
    if(intensity<.25){r=8;g=8;b2=18+intensity*50;}
    else if(intensity<.5){r=8+intensity*90;g=8;b2=70;}
    else if(intensity<.75){r=intensity*220;g=intensity*70;b2=15;}
    else{r=255;g=255*intensity;b2=intensity*150;}
    ctx.fillStyle=`rgb(${Math.floor(r)},${Math.floor(g)},${Math.floor(b2)})`;
    ctx.fillRect(x*cw,y*rh,cw-.5,rh-.5);
  }
}

// ═══ SIMULATOR UI ═══════════════════════════════════════════════
let simTime='24h';
function setSimTime(t,el){
  simTime=t;
  document.getElementById('sim-time-24h').classList.toggle('act',t==='24h');
  document.getElementById('sim-time-wk').classList.toggle('act',t==='weekend');
  updateSim();
}
function updateSim(){
  const spotShift=parseFloat(document.getElementById('sim-spot')?.value||0);
  const volShift=parseFloat(document.getElementById('sim-vol')?.value||0);
  const sv=document.getElementById('sim-spot-val');if(sv)sv.textContent=`${spotShift>=0?'+':''}${spotShift}%`;
  const vv=document.getElementById('sim-vol-val');if(vv)vv.textContent=`${volShift>=0?'+':''}${volShift} pts`;
  const result=simulateDealerHedge(spotShift,volShift,simTime);
  const re=document.getElementById('sim-result');
  const ex=document.getElementById('sim-explain');
  if(re)re.innerHTML=`<span style="color:${result.direction==='BUY'?'var(--green)':'var(--red)'}">${result.direction} ${fmt(Math.abs(result.totalUSD))}</span>`;
  if(ex)ex.textContent=result.explain;
}

// ═══ INTERACTIONS ═══════════════════════════════════════════════
let fvAsset="BTC";
function setFVAsset(sym,el){fvAsset=sym;el.parentElement.querySelectorAll('.pill').forEach(p=>p.classList.remove('act'));el.classList.add('act');renderFVPanel();renderProbCone();}
function selectAsset(sym){selectedAsset=sym;}
function clearSelected(e){e.stopPropagation();selectedAsset=null;}
function setTMMode(m,el){tmMode=m;el.parentElement.querySelectorAll('.pill').forEach(p=>p.classList.remove('act'));el.classList.add('act');renderTreemap();}
function setGLTab(t,el){glTab=t;el.parentElement.querySelectorAll('.mtab').forEach(x=>x.classList.remove('active'));el.classList.add('active');renderGL();}
function setBubTF(tf,el){bubTF=tf;el.parentElement.querySelectorAll('.pill').forEach(p=>p.classList.remove('act'));el.classList.add('act');renderBubbles();}
function setTblTF(tf,el){tblTF=tf;el.parentElement.querySelectorAll('.pill').forEach(p=>p.classList.remove('act'));el.classList.add('act');renderTable();}
function setCat(c,el){catFilter=c;el.parentElement.querySelectorAll('.cat-b').forEach(b=>b.classList.remove('act'));el.classList.add('act');renderTable();}
function tSort(k){if(tSortK===k)tSortD=tSortD==="desc"?"asc":"desc";else{tSortK=k;tSortD="desc"}renderTable();}
function updateClock(){const el=document.getElementById("clock");if(el)el.textContent=new Date().toUTCString().slice(17,25)+" UTC";}

function switchTab(t){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.mtab').forEach(m=>m.classList.remove('active'));
  const panel=document.getElementById("panel-"+t);if(panel)panel.classList.add('active');
  if(event&&event.target)event.target.classList.add('active');
  // Tab-specific renders
  if(t==='greeks'){renderVanna();renderCharm();renderVannaCharmSignal();}
  if(t==='simulator')updateSim();
  if(t==='optionslab'){renderIVHeatmap("iv-heatmap-full");renderIVRV("ivrv-body-full");renderFlowFeed("flow-feed-full","all");renderSkewMonitor();}
  if(t==='positioning'){renderGEX();renderFunding("fund-body-pos");drawGammaProfile("gflip-canvas-btc","BTC","gflip-meta-btc","gflip-zone-btc");drawGammaProfile("gflip-canvas-eth","ETH","gflip-meta-eth","gflip-zone-eth");}
  if(t==='fairvalue'){renderFVPanel();renderProbCone();}
  if(t==='funding'){renderFunding("fund-body");renderLiqData();const bp=(D.find(d=>d.s==="BTC")||{p:98450}).p;drawLiqHeatmap("liq-btc",bp,bp*0.86,bp*1.17);}
  if(t==='scanner'){renderTable();renderCats();}
}

// ═══ TICK ═══════════════════════════════════════════════════════
function tick(){
  D=D.map(t=>({...t,
    ivRv:+(t.iv-t.rv30).toFixed(1),
    conviction:Math.min(98,Math.floor(
      Math.abs(t.ivRank-50)/50*40+
      Math.min(20,Math.abs(t.skew25d)*2)+
      (Math.abs(t.fund)>0.04?20:Math.abs(t.fund)*300)+
      (t.gammaExp<0?15:5)+
      Math.abs(t.iv-t.rv30)/Math.max(1,t.rv30)*5
    ))
  }));
  updateIVRatios();
  renderAll();
  FLOWS.forEach(f=>{if(f.age!=null)f.age++;});
}

function renderAll(){
  renderMkt();renderFG();renderRegime();renderTicker();
  const tab=document.querySelector('.tab-panel.active')?.id;
  if(currentMode==='spot'){
    if(tab==='panel-dashboard'){renderTreemap();renderGL();renderBubbles();renderNews("news-dash");}
    if(tab==='panel-funding'){renderFunding("fund-body");renderLiqData();}
    if(tab==='panel-scanner')renderTable();
    if(tab==='panel-intel')renderNews("news-full");
  } else {
    if(tab==='panel-signals'){renderSignals();renderExpectedMove("em-btc","BTC");renderExpectedMove("em-eth","ETH");renderExpectedMove("em-sol","SOL");renderMaxPain();}
    if(tab==='panel-greeks'){renderVanna();renderCharm();renderVannaCharmSignal();}
    if(tab==='panel-simulator')updateSim();
    if(tab==='panel-optionslab'){renderIVHeatmap("iv-heatmap-full");renderIVRV("ivrv-body-full");renderFlowFeed("flow-feed-full","all");renderSkewMonitor();}
    if(tab==='panel-positioning'){renderGEX();}
    if(tab==='panel-fairvalue'){renderFVPanel();renderProbCone();}
  }
}

// ═══ INIT ═══════════════════════════════════════════════════════
function initApp(){
  initIVRatioHistory();
  updateSecondOrderGreeks();
  setMode('spot'); // default to Spot mode
  renderAll();
  updateClock();
  setInterval(tick,7000);
  setInterval(updateClock,1000);
  LiveData.start().catch(e=>console.warn('[LiveData] Start failed:',e.message));
  window.addEventListener("resize",()=>{renderBubbles();if(document.querySelector('#panel-fairvalue.active'))renderProbCone();});
  // Bind scanner search if present
  setTimeout(()=>{
    const s=document.getElementById("tbl-search");if(s)s.addEventListener("input",renderTable);
  },100);
}

// ═══ BOOT ═══════════════════════════════════════════════════════
checkSession();
</script>
</body>
</html>
